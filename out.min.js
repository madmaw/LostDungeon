var ALL_FEATURES_ON=true;var FEATURE_ROUNDED_BRICKS=ALL_FEATURES_ON;var FEATURE_AUTO_ORIENT_PLAYER=ALL_FEATURES_ON;var FEATURE_DROP_RANDOM_POSITIONS_ON_DEATH=ALL_FEATURES_ON;var FEATURE_LOOK_AT_ATTACKER=ALL_FEATURES_ON;var FEATURE_CHECK_SHADER_ERRORS=ALL_FEATURES_ON;var FEATURE_SOUND=ALL_FEATURES_ON;var FEATURE_SOUND_VIBRATO=ALL_FEATURES_ON;var FEATURE_SOUND_LEGACY_WEB_AUDIO=ALL_FEATURES_ON;var FEATURE_PRINT_LEVEL=ALL_FEATURES_ON;var FEATURE_BOSS=ALL_FEATURES_ON;var FEATURE_TUTORIAL=ALL_FEATURES_ON;
var FEATURE_MULTIPLE_EASING=ALL_FEATURES_ON;var FEATURE_PERSISTENCE=ALL_FEATURES_ON;var FEATURE_HOME_BACKGROUND=ALL_FEATURES_ON;var FEATURE_ANIMATE_FALL=ALL_FEATURES_ON;var FEATURE_ANIMATE_CONSUME_FEATURE=ALL_FEATURES_ON;var FEATURE_SHOW_WIN=ALL_FEATURES_ON;
function stateDefaultInit(state,stateListener,eventListeners){state.stateElement=getElemById(state.stateElementId);state.stateElement.removeAttribute("class");state.stateListener=stateListener;mapForEach(eventListeners,function(name,eventListener){w.addEventListener(name,eventListener,{passive:false})});state.eventListeners=eventListeners}
function stateDefaultDestroy(){var state=this;setAttrib(state.stateElement,"class","h");mapForEach(state.eventListeners,function(name,eventListener){w.removeEventListener(name,eventListener,{passive:false})})}var pi=Math.PI;var pi2=pi*2;var piOn2=pi/2;var nil=null;var max=Math.max;var min=Math.min;var w=window;var doc=document;var abs=Math.abs;var floor=Math.floor;var ceil=Math.ceil;var sin=Math.sin;var cos=Math.cos;var random=Math.random;var sqrt=Math.sqrt;var ls=w["localStorage"];
function getElemById(id){return doc.getElementById(id)}function setAttrib(e,key,value){e.setAttribute(key,value)}function arrayPush(a,v){a.push(v)}function arraySplice(a,index,deleteCount,value){return value!=undefined?a.splice(index,deleteCount,value):a.splice(index,deleteCount)}var easingLinearFactory;if(FEATURE_MULTIPLE_EASING)easingLinearFactory=function(duration){return function(t){return t/duration}};else easingLinearFactory=easingQuadraticOutFactory;
function animationChainedProxyFactory(originalAnimation,nextAnimationFactory){var animation=originalAnimation;return function(t,forceEnd){var done=animation(t,forceEnd);if(done&&nextAnimationFactory){animation=nextAnimationFactory(t);nextAnimationFactory=nil;if(animation)if(forceEnd)animation(0,forceEnd);else done=0}return done}}
function animationCompositeFactory(animations){return function(t,forceEnd){return arrayForEachReverse(animations,function(animation){var done=animation(t,forceEnd);return done})}}function animationTweenFactory(startTime,duration,easing,effects){return function(time,forceEnd){var dtime=time-startTime;if(forceEnd||dtime>=duration)dtime=duration;var done=dtime>=duration;var progress=easing(dtime);arrayForEach(effects,function(effect){effect(progress)});return done}}var easingQuadraticInFactory;
if(FEATURE_MULTIPLE_EASING)easingQuadraticInFactory=function(duration){return function(t){var st=t/duration;return st*st}};else easingQuadraticInFactory=easingQuadraticOutFactory;function easingQuadraticOutFactory(duration){return function(t){var st=t/duration;var a=1-st;return 1-a*a}}function effectCopyMatrixIntoFactory(target,valueFactory){return function(p){var value=valueFactory(p,target);matrixCopyInto4(value,target)}}
function valueFactoryMatrix4InterpolationFactory(from,to){return function(p,value){if(!value)value=matrixIdentity4();arrayForEach(from,function(vfrom,i){var vto=to[i];var v=vfrom+(vto-vfrom)*p;value[i]=v});return value}}function valueFactoryMatrix4RotationFactory(aroundX,aroundY,aroundZ,fromAngle,toAngle){return function(p,value){if(!value)value=matrixIdentity4();var angle=fromAngle+(toAngle-fromAngle)*p;matrixCopyInto4(matrixRotate4(aroundX,aroundY,aroundZ,angle),value);return value}}
function delegatingStateFactory(stateFactories){return function(stateTypeId,data){return stateFactories[stateTypeId](stateTypeId,data)}}var BEHAVIOR_TYPE_PLAYER=1;var BEHAVIOR_TYPE_MONSTER=2;var DICE_FACE_FRONT=0;var DICE_FACE_BACK=1;var DICE_FACE_TOP=2;var DICE_FACE_BOTTOM=3;var DICE_FACE_RIGHT=4;var DICE_FACE_LEFT=5;function newAxisAndAngleAndMatrix(axisX,axisY,axisZ,radians){return{axisX:axisX,axisY:axisY,axisZ:axisZ,radians:radians,matrix:matrixRotate4(axisX,axisY,axisZ,radians)}}
var DICE_FACE_ROTATIONS=[newAxisAndAngleAndMatrix(1,0,0,-piOn2),newAxisAndAngleAndMatrix(1,0,0,piOn2),newAxisAndAngleAndMatrix(0,1,0,0),newAxisAndAngleAndMatrix(0,1,0,pi),newAxisAndAngleAndMatrix(0,0,1,piOn2),newAxisAndAngleAndMatrix(0,0,1,piOn2)];var DICE_SYMBOL_ATTACK=0;var DICE_SYMBOL_RESOURCE_FIRE=1;var DICE_SYMBOL_RESOURCE_WATER=2;var DICE_SYMBOL_RESOURCE_LIFE=3;var DICE_SYMBOL_DEFEND=4;var DICE_SYMBOL_COUNT=5;
var DICE_SYMBOL_CHARACTERS=["\u2020","\u25cf","\u25cf","\u25cf","\u2665","\u25cb","\u25cb","\u25cb"];var DICE_SYMBOL_COLORS=["#000","#800","#008","#080","#000","#800","#008","#080"];var DICE_SYMBOL_ROTATION=[0,-piOn2,-piOn2,-piOn2,piOn2,-piOn2,-piOn2,-piOn2];var DICE_SYMBOL_PLAY_DESIRABILITY=[1,.1,.1,.1,1,.1,.1,.1];var DICE_SYMBOL_COLLECT_DESIRABILITY=[0,1,1,1,0,.2,.2,.2];var DICE_SYMBOL_OFFENSIVENESS=[5,-1,-1,-1,-5,1,1,1];var DICE_SYMBOL_RESOURCE_VALUES={1:{1:1,5:-1},2:{2:1,6:-1},3:{3:1,7:-1}};
function isSymbolResource(symbol){return DICE_SYMBOL_RESOURCE_VALUES[symbol]}var pickUpToPlay=["pick","up","to","play","","dice"];function copySentenceAndSetWord(word){var result=copyArray(pickUpToPlay);result[4]=word;return result}var NEUTRAL_DICE_HINT_SCRIBBLES=[copySentenceAndSetWord("big"),copySentenceAndSetWord("red"),copySentenceAndSetWord("blue"),copySentenceAndSetWord("green"),["drop","to","defend","","look","down","to","drop"],["DANGER","do","NOT","step","on!","","throw","to","attack"]];
var DICE_TYPE_HINT_SYMBOL_COSTS={0:[[nil,.7,.7,.7],[nil,.8],[nil,nil,.8],[nil,nil,nil,.8],[nil,nil,nil,nil,1],[1]],1:[[.75,0,nil,nil,nil,nil,nil,.1],[nil,.5,nil,nil,nil,nil,nil,-.1]],2:[[1,nil,nil,nil,nil,.3],[nil,nil,.5,nil,.7,-.1],[nil,nil,.6]],3:[[.8,nil,nil,nil,nil,nil,.1],[nil,nil,nil,.6,.8,nil,-.1],[nil,nil,nil,.6,nil,nil,-.1]]};var DICE_TYPE_NEUTRAL=0;var DICE_TYPE_FIRE=1;var DICE_TYPE_WATER=2;var DICE_TYPE_LIFE=3;var DICE_TYPE_COLORS=["#fff","#faa","#aaf","#afa"];var ENTITY_TYPE_PLAYER=0;
var ENTITY_TYPE_MONSTER=1;var ENTITY_TYPE_BOSS=2;var ENTITY_TYPE_COLORS=["#f6b","#f00","#000"];var FEATURE_TYPE_NONE=0;var FEATURE_TYPE_BONUS_DICE_SLOT=1;var FEATURE_TYPE_BONUS_HEALTH=2;var FEATURE_TYPE_ALL=[FEATURE_TYPE_NONE,FEATURE_TYPE_BONUS_DICE_SLOT,FEATURE_TYPE_BONUS_HEALTH];var FEATURE_TYPE_COUNT=3;var FEATURE_TYPE_NAMES=[nil,"!","\u2665"];var FEATURE_TYPE_COLORS=[nil,{upper:"#0f0",lower:"#afa"},{upper:"#f6c",lower:"#f00"}];var FEATURE_TYPE_SCRIBBLES=[nil,["carry","more"],["health","up"]];
var GAME_STATE_IN_PROGRESS=0;var GAME_STATE_DEAD=1;var GAME_STATE_WON=2;var ORIENTATION_NORTH=0;var ORIENTATION_EAST=1;var ORIENTATION_SOUTH=2;var ORIENTATION_WEST=3;var ORIENTATION_ALL=[ORIENTATION_NORTH,ORIENTATION_EAST,ORIENTATION_SOUTH,ORIENTATION_WEST];var ORIENTATION_DIFFS=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];var ORIENTATION_DIFFS_CORNERS=copyArray(ORIENTATION_DIFFS);arrayPushAll(ORIENTATION_DIFFS_CORNERS,[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}]);
var ORIENTATION_ANGLES=[0,-piOn2,pi,piOn2];var RESOURCE_TYPE_FIRE=DICE_TYPE_FIRE;var RESOURCE_TYPE_WATER=DICE_TYPE_WATER;var RESOURCE_TYPE_LIFE=DICE_TYPE_LIFE;var RESOURCE_TYPE_ALL=[RESOURCE_TYPE_FIRE,RESOURCE_TYPE_WATER,RESOURCE_TYPE_LIFE];function zeroResourceMap(){return{1:0,2:0,3:0}}var TILE_SLOTS_OFFENSIVE={};var TILE_SLOTS_DEFENSIVE={};var TILE_SLOTS_ALL={};var dimension=5;var TILE_SLOT_COUNT=dimension*dimension;var c=.5/dimension-.5;var piOn6=pi/6;
countForEach(dimension,function(x){countForEach(dimension,function(y){var tileSlotBag;if(x&&y&&x<dimension-1&&y<dimension-1)tileSlotBag=TILE_SLOTS_DEFENSIVE;else tileSlotBag=TILE_SLOTS_OFFENSIVE;var index=x+y*dimension;var tileSlot={dx:x/dimension+c,dy:y/dimension+c,slotRotation:random()*piOn6+piOn6};tileSlotBag[index]=tileSlot;TILE_SLOTS_ALL[index]=tileSlot})});var TILE_TYPE_SOLID=0;var TILE_TYPE_FLOOR=1;var TILE_TYPE_PIT=2;var TILE_TYPE_ROOFLESS=3;var TILE_TYPE_HIDDEN=4;
function isTileTypeSolid(tileType){return tileType==TILE_TYPE_SOLID}function createElement(name,attributes){var e=doc.createElement(name);mapForEach(attributes,function(key,value){setAttrib(e,key,value)});return e}
function homeStateFactory(gameService){return function(stateId,stateData){var result={stateElementId:"h",initState:function(stateListener){stateDefaultInit(result,stateListener,{});var universe=gameService.getUniverse();var element=result.stateElement;if(FEATURE_SHOW_WIN){var successElement=getElemById("w");if(stateData&&stateData.justExited)successElement.removeAttribute("class");else successElement.setAttribute("class","h")}var newGameElement=getElemById("n");newGameElement.onclick=function(){var game=
gameService.createGame();var playerEntity={entityOrientation:ORIENTATION_NORTH,side:1,id:game.nextEntityId++,behaviorType:BEHAVIOR_TYPE_PLAYER,resourceCounts:{},dice:[],healthSlots:1,diceSlots:3,entityType:ENTITY_TYPE_PLAYER};var data={game:game,playerTransition:{entity:playerEntity,entryLocation:{levelId:game.nextLevelId,tileName:"10"}}};stateListener(STATE_TYPE_PLAY,data)};setAttrib(newGameElement,"href","#_"+universe.nextGameId);var existingGamesElement=getElemById("e");existingGamesElement.innerHTML=
"";if(FEATURE_HOME_BACKGROUND){var rng=mathRandomNumberGenerator;var colors=createRandomWallColors(rng);var dimension_1=min(element.clientHeight,element.clientWidth);var backgroundImageUpper=createRepeatingBrickPattern(rng,dimension_1,dimension_1,5,8,.5,0,colors.wallUpper,colors.wallLower,4,.5,colors.grout,"LOST DUNGEON ".split(""));var backgroundImageLower=createRepeatingBrickPattern(rng,dimension_1,dimension_1,5,8,.5,0,colors.wallLower,colors.wallUpper,4,.5,colors.grout,"LOST DUNGEON ".split(""));
var backgroundImage=createCanvas(dimension_1,dimension_1*2);var backgroundContext=backgroundImage.getContext("2d");backgroundContext.drawImage(backgroundImageUpper,0,0);backgroundContext.drawImage(backgroundImageLower,0,dimension_1);var dataURL=backgroundImage.toDataURL();setAttrib(element,"style","background-image:url("+dataURL+")")}if(FEATURE_PERSISTENCE){var games=gameService.getGames(universe.gameIds);arrayForEachReverse(games,function(game){var elementName="a";var elementAttributes;var status;
if(!game.gameState){status="Last Played ";elementAttributes={"href":"#"+game.gameId}}else if(game.gameState==GAME_STATE_WON)status="Escaped ";else status="Died ";var a=createElement(elementName,elementAttributes);a.innerHTML="<h2>Expedition "+game.gameId+"</h2>Depth "+game.playerLevelId+"<br>"+status+game.updated;if(!game.gameState)a.onclick=function(){var data={game:game};stateListener(STATE_TYPE_PLAY,data)};existingGamesElement.appendChild(a)})}},destroyState:stateDefaultDestroy};return result}}
var matrixCopy4=copyArray;function matrixCopyInto4(from,into){for(var i=0;i<16;i++)into[i]=from[i]}function matrixIdentity4(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}
function matrixInvert4(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+
b02*b09+b03*b08-b04*b07+b05*b06;if(det){det=1/det;return[(a11*b11-a12*b10+a13*b09)*det,(a02*b10-a01*b11-a03*b09)*det,(a31*b05-a32*b04+a33*b03)*det,(a22*b04-a21*b05-a23*b03)*det,(a12*b08-a10*b11-a13*b07)*det,(a00*b11-a02*b08+a03*b07)*det,(a32*b02-a30*b05-a33*b01)*det,(a20*b05-a22*b02+a23*b01)*det,(a10*b10-a11*b08+a13*b06)*det,(a01*b08-a00*b10-a03*b06)*det,(a30*b04-a31*b02+a33*b00)*det,(a21*b02-a20*b04-a23*b00)*det,(a11*b07-a10*b09-a12*b06)*det,(a00*b09-a01*b07+a02*b06)*det,(a31*b01-a30*b03-a32*b00)*
det,(a20*b03-a21*b01+a22*b00)*det]}}function matrixMultiply4(a,b,out){if(!out)out=matrixIdentity4();countForEach(16,function(x){var i=x>>2;var j=x%4;var v=0;countForEach(4,function(k){v+=a[i+k*4]*b[k+j*4]});out[i+j*4]=v});return out}function matrixMultiplyStack4(matrices){var current=matrixIdentity4();arrayForEach(matrices,function(matrix){current=matrixMultiply4(current,matrix)});return current}
function matrixPerspective4(fovy,aspect,znear,zfar){var top=znear*Math.tan(fovy/2);var bottom=-top;var left=bottom*aspect;var right=top*aspect;var X=2*znear/(right-left);var Y=2*znear/(top-bottom);var A=(right+left)/(right-left);var B=(top+bottom)/(top-bottom);var C=-(zfar+znear)/(zfar-znear);var D=-2*zfar*znear/(zfar-znear);return[X,0,0,0,0,Y,0,0,A,B,C,-1,0,0,D,0]}
function matrixRotate4(x,y,z,rad){var s,c,t;s=sin(rad);c=cos(rad);t=1-c;return[x*x*t+c,y*x*t-z*s,z*x*t-y*s,0,x*y*t+z*s,y*y*t+c,z*y*t-x*s,0,x*z*t+y*s,y*z*t+x*s,z*z*t+c,0,0,0,0,1]}function matrixRotateX4(radians){return matrixRotate4(1,0,0,radians)}function matrixRotateY4(radians){return matrixRotate4(0,1,0,radians)}function matrixRotateZ4(radians){return matrixRotate4(0,0,1,radians)}function matrixScale4(x,y,z){return[x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1]}
function matrixTranslate4(x,y,z){return[1,0,0,0,0,1,0,0,0,0,1,0,x,y,z,1]}function vectorTransform3Matrix4(x,y,z,m){var w=m[3]*x+m[7]*y+m[11]*z+m[15];w=w||1;return[(m[0]*x+m[4]*y+m[8]*z+m[12])/w,(m[1]*x+m[5]*y+m[9]*z+m[13])/w,(m[2]*x+m[6]*y+m[10]*z+m[14])/w]}
function levelFindTile(level,searchFunction){var total=level.levelWidth*level.levelHeight;for(var i=0;i<total;i++){var x=i%level.levelWidth;var y=floor(i/level.levelWidth);var column=level.tiles[x];var tile=column[y];if(searchFunction(tile,x,y))return tile}}function levelGetPosition(level,entity){var point;levelFindTile(level,function(tile,x,y){if(tile.entity==entity){point={x:x,y:y};return true}});return point}
function countSurroundingTiles(tiles,width,height,tx,ty,f,includeCorners){var count=0;var diffs=includeCorners?ORIENTATION_DIFFS_CORNERS:ORIENTATION_DIFFS;arrayForEach(diffs,function(diff){var x=tx+diff.x;var y=ty+diff.y;if(x>=0&&x<width&&y>=0&&y<height){var result=f(tiles[x][y],x,y);if(result)count+=result}});return count}
function getBestAvailableTileSlotKey(tileSlots,tile,targetDiffX,targetDiffY){var targetSlot;var targetSlotKey;mapForEach(tileSlots,function(key,slot){if(!tile.dice[key]){var ok=!targetSlot;if(!ok){var dx=targetDiffX-slot.dx;var dy=targetDiffY-slot.dy;var currentDx=targetDiffX-targetSlot.dx;var currentDy=targetDiffY-targetSlot.dy;ok=dx*dx+dy*dy<currentDx*currentDx+currentDy*currentDy}if(ok){targetSlot=slot;targetSlotKey=key}}});return targetSlotKey}var INPUT_TYPE_NONE=0;
var INPUT_TYPE_MOVE_FORWARD=1;var INPUT_TYPE_TURN=2;var INPUT_TYPE_LOOK_DOWN=3;var INPUT_TYPE_COLLECT_DICE=4;var INPUT_TYPE_PLAY_DICE=5;var LEVEL_DELTA_TYPE_MOVE=1;var LEVEL_DELTA_TYPE_MOVE_INVALID=2;var LEVEL_DELTA_TYPE_TURN=3;var LEVEL_DELTA_TYPE_LOOK_DOWN=4;var LEVEL_DELTA_TYPE_LOOK_UP=5;var LEVEL_DELTA_TYPE_FALL=6;var LEVEL_DELTA_TYPE_CHANGE_STATE=7;var LEVEL_DELTA_TYPE_DIE=8;var LEVEL_DELTA_TYPE_DROP_IN=9;var LEVEL_DELTA_TYPE_COLLECT_DICE=10;var LEVEL_DELTA_TYPE_PLAY_DICE=11;
var LEVEL_DELTA_TYPE_RESOURCE_CHANGE=12;var LEVEL_DELTA_TYPE_HEALTH_CHANGE=13;var LEVEL_DELTA_TYPE_CONSUME_FEATURE=14;var LEVEL_DELTA_TYPE_DICE_SLOTS_CHANGE=15;var PLAY_DICE_FAILURE_REASON_BLOCKED=1;var PLAY_DICE_FAILURE_REASON_NOT_YOUR_DICE=2;var PLAY_DICE_FAILURE_REASON_NO_ROOM=3;var PLAY_DICE_FAILURE_REASON_NO_RESOURCES=4;var COLLECT_DICE_FAILURE_REASON_NOT_FOUND=1;var COLLECT_DICE_FAILURE_REASON_NO_ROOM=2;var COLLECT_DICE_FAILURE_REASON_NOT_YOUR_DICE=3;
var COLLECT_DICE_FAILURE_REASON_TOO_FAR=4;var COLLECT_DICE_FAILURE_REASON_NO_RESOURCES=5;var COLLECT_DICE_FAILURE_REASON_DEAD=6;
function createLevelUpdater(game,level){var entitiesInOrder=[];var currentTurnEntityIndex=0;var inputQueue=[];var waitingOnInput;levelFindTile(level,function(tile){if(tile.entity)arrayPush(entitiesInOrder,tile.entity)});function sortEntitiesInOrder(){entitiesInOrder.sort(function(a,b){return a.id-b.id})}function getRollCost(entity,resourceType,resourceQuantity,resourcesUsed){var effectiveResourceCounts=levelUpdater.getEffectiveResourceCounts(entity);var acceptableResourceTypes=[resourceType];if(!resourceType)acceptableResourceTypes=
RESOURCE_TYPE_ALL;arrayForEach(acceptableResourceTypes,function(acceptableResourceType){var effectiveResourceCount=effectiveResourceCounts[acceptableResourceType];var resourceUsed=max(0,min(effectiveResourceCount,resourceQuantity));resourcesUsed[acceptableResourceType]-=resourceUsed;resourceQuantity-=resourceUsed});return resourceQuantity>0}function turnToOrientation(entity,orientation){var oldOrientation=entity.entityOrientation;entity.entityOrientation=orientation;return{deltas:[{deltaType:LEVEL_DELTA_TYPE_TURN,
deltaData:{entity:entity,fromOrientation:oldOrientation,toOrientation:orientation}}]}}function moveForward(entity){var orientation=entity.entityOrientation;var dpos=ORIENTATION_DIFFS[orientation];var pos=levelGetPosition(level,entity);var x=pos.x+dpos.x;var y=pos.y+dpos.y;var valid=x>=0&&y>=0&&x<level.levelWidth&&y<level.levelHeight;var deltaType=LEVEL_DELTA_TYPE_MOVE_INVALID;var moveData={moveDirection:orientation,fromX:pos.x,fromY:pos.y,entity:entity};var deltas;if(valid){var targetTile=level.tiles[x][y];
valid=targetTile.tileType!=TILE_TYPE_SOLID&&!targetTile.entity;if(valid){var sourceTile=level.tiles[pos.x][pos.y];var previousHealth=getEffectiveHealth(entity,pos.x,pos.y);sourceTile.entity=nil;targetTile.entity=entity;var oldResourceCounts=entity.resourceCounts;entity.resourceCounts=zeroResourceMap();var resourceDelta={entity:entity,resourceDeltas:oldResourceCounts,newEffectiveResourceCounts:levelUpdater.getEffectiveResourceCounts(entity)};var children=void 0;if(targetTile.tileType==TILE_TYPE_PIT){var fallChildren=
[{deltaType:LEVEL_DELTA_TYPE_DIE,deltaData:{entity:entity}}];if(entity.behaviorType==BEHAVIOR_TYPE_PLAYER)arrayPush(fallChildren,{deltaType:LEVEL_DELTA_TYPE_CHANGE_STATE,deltaData:{stateTypeId:STATE_TYPE_PLAY,stateData:{game:game,playerTransition:{entity:entity,entryLocation:{levelId:game.nextLevelId,tileName:targetTile.tileName}}}}});children=[{deltaType:LEVEL_DELTA_TYPE_FALL,deltaData:{entity:entity,tileX:pos.x,tileY:pos.y},deltaChildren:fallChildren}]}else children=applyAmbientEffects(entity,previousHealth);
if(targetTile.featureType){var featureChildren=void 0;switch(targetTile.featureType){case FEATURE_TYPE_BONUS_DICE_SLOT:entity.diceSlots++;featureChildren=[{deltaType:LEVEL_DELTA_TYPE_DICE_SLOTS_CHANGE,deltaData:{diceSlotDelta:1,diceSlots:entity.diceSlots}}];break;case FEATURE_TYPE_BONUS_HEALTH:entity.healthSlots++;featureChildren=[{deltaType:LEVEL_DELTA_TYPE_HEALTH_CHANGE,deltaData:{deltaHealth:1,totalHealth:entity.healthSlots,entity:entity}}];break}targetTile.featureType=FEATURE_TYPE_NONE;arrayPushAll(featureChildren,
children);children=[{deltaType:LEVEL_DELTA_TYPE_CONSUME_FEATURE,deltaData:{entity:entity,featureTile:targetTile,fromTileX:x,fromTileY:y},deltaChildren:featureChildren}]}deltas=[{deltaType:LEVEL_DELTA_TYPE_MOVE,deltaData:moveData,deltaChildren:children},{deltaType:LEVEL_DELTA_TYPE_RESOURCE_CHANGE,deltaData:resourceDelta}]}}if(!valid)deltas=[{deltaType:LEVEL_DELTA_TYPE_MOVE_INVALID,deltaData:moveData}];return{moveToNext:valid,deltas:deltas}}function getEffectiveHealth(entity,tx,ty){if(entity){var health_1=
entity.healthSlots;var tile=level.tiles[tx][ty];mapForEach(tile.dice,function(key,diceAndFace){if(diceAndFace){var symbols=diceAndFace.dice.symbols[diceAndFace.upturnedFace];arrayForEach(symbols,function(symbol){if(symbol==DICE_SYMBOL_ATTACK)health_1--;else if(symbol==DICE_SYMBOL_DEFEND)health_1++})}});return max(0,min(health_1,entity.healthSlots))}}function applyAmbientEffects(entity,currentHealth){var result=[];if(!entity.dead){var entityPos=levelGetPosition(level,entity);var newHealth=getEffectiveHealth(entity,
entityPos.x,entityPos.y);var delta=newHealth-currentHealth;if(delta||!newHealth){var children=void 0;entity.dead=!newHealth;if(entity.dead){var tile=level.tiles[entityPos.x][entityPos.y];children=[{deltaType:LEVEL_DELTA_TYPE_DIE,deltaData:{entity:entity}}];arrayForEach(entity.dice,function(dice){if(dice){var canPlayDiceResult=canPlayDice(entity,dice.diceId,1,1);if(!canPlayDiceResult.failureReason){var actionResult=playDice(entity,canPlayDiceResult);if(actionResult&&actionResult.deltas)arrayPushAll(result,
actionResult.deltas)}}});tile.entity=nil}arrayPush(result,{deltaType:LEVEL_DELTA_TYPE_HEALTH_CHANGE,deltaData:{entity:entity,deltaHealth:delta,totalHealth:newHealth},deltaChildren:children})}}return result}function look(entity,down){var deltas;if(entity.lookingDown!=down){entity.lookingDown=down;deltas=[{deltaType:down?LEVEL_DELTA_TYPE_LOOK_DOWN:LEVEL_DELTA_TYPE_LOOK_UP,deltaData:{entity:entity}}]}return{deltas:deltas}}function canCollectDice(entity,data){var entityPos=levelGetPosition(level,entity);
var failureReason;var result;if(entityPos){var diff=abs(entityPos.x-data.tileX)+abs(entityPos.y-data.tileY);var fromTile=level.tiles[data.tileX][data.tileY];var diceAndFace_1=fromTile.dice[data.dicePosition];if(diff<=1)if(diceAndFace_1&&diceAndFace_1.dice.diceId==data.diceId){var toEntity_1=entity;if(fromTile.entity&&diceAndFace_1.dice.owner!=entity.id){toEntity_1=fromTile.entity;levelFindTile(level,function(tile,x,y){if(tile.entity&&tile.entity.id==diceAndFace_1.dice.owner){var diff_1=abs(x-data.tileX)+
abs(y-data.tileY);if(diff_1<=1)toEntity_1=tile.entity}})}while(toEntity_1.dice.length<toEntity_1.diceSlots)arrayPush(toEntity_1.dice,nil);var targetSlot_1;arrayForEach(toEntity_1.dice,function(dice,index){if(targetSlot_1==nil&&!dice)targetSlot_1=index});if(targetSlot_1!=nil){var resourceValueDeltas_1=zeroResourceMap();if(!diff)arrayForEach(diceAndFace_1.dice.symbols[diceAndFace_1.upturnedFace],function(symbol){var symbolResourceValues=DICE_SYMBOL_RESOURCE_VALUES[symbol];mapForEach(symbolResourceValues,
function(resourceType,value){if(value>0)resourceValueDeltas_1[resourceType]+=value})});if(toEntity_1!=entity)if(!diff){var failed=getRollCost(entity,diceAndFace_1.dice.diceType,diceAndFace_1.dice.diceLevel+1,resourceValueDeltas_1);if(failed)failureReason=COLLECT_DICE_FAILURE_REASON_NO_RESOURCES}else failureReason=COLLECT_DICE_FAILURE_REASON_TOO_FAR;result={dice:diceAndFace_1.dice,fromFace:diceAndFace_1.upturnedFace,fromTilePosition:data.dicePosition,fromTileX:data.tileX,fromTileY:data.tileY,resourceDeltas:resourceValueDeltas_1,
resourceEntity:entity,toEntity:toEntity_1,toDiceSlot:targetSlot_1}}else failureReason=COLLECT_DICE_FAILURE_REASON_NO_ROOM}else failureReason=COLLECT_DICE_FAILURE_REASON_NOT_FOUND;else failureReason=COLLECT_DICE_FAILURE_REASON_TOO_FAR}else failureReason=COLLECT_DICE_FAILURE_REASON_DEAD;if(!result)result={};result.failureReason=failureReason;return result}function collectDice(entity,canCollectDiceResult){var deltas;if(!canCollectDiceResult.failureReason){var fromTile=level.tiles[canCollectDiceResult.fromTileX][canCollectDiceResult.fromTileY];
var previousHealth=getEffectiveHealth(fromTile.entity,canCollectDiceResult.fromTileX,canCollectDiceResult.fromTileY);fromTile.dice[canCollectDiceResult.fromTilePosition]=nil;canCollectDiceResult.toEntity.dice[canCollectDiceResult.toDiceSlot]=canCollectDiceResult.dice;canCollectDiceResult.dice.owner=canCollectDiceResult.toEntity.id;mapForEach(canCollectDiceResult.resourceDeltas,function(resourceType,value){canCollectDiceResult.resourceEntity.resourceCounts[resourceType]+=value});var children=void 0;
if(fromTile.entity)children=applyAmbientEffects(fromTile.entity,previousHealth);deltas=[{deltaType:LEVEL_DELTA_TYPE_COLLECT_DICE,deltaData:{entity:canCollectDiceResult.toEntity,dice:canCollectDiceResult.dice,toDiceSlot:canCollectDiceResult.toDiceSlot,fromTileX:canCollectDiceResult.fromTileX,fromTileY:canCollectDiceResult.fromTileY,fromTilePosition:canCollectDiceResult.fromTilePosition,fromFace:canCollectDiceResult.fromFace},deltaChildren:[{deltaType:LEVEL_DELTA_TYPE_RESOURCE_CHANGE,deltaData:{entity:canCollectDiceResult.resourceEntity,
resourceDeltas:canCollectDiceResult.resourceDeltas,newEffectiveResourceCounts:levelUpdater.getEffectiveResourceCounts(canCollectDiceResult.resourceEntity)},deltaChildren:children}]}]}return{deltas:deltas}}function canPlayDice(entity,diceId,lookingDown,dropping){var entityPos=levelGetPosition(level,entity);var toTileX;var toTileY;var targetOrientation;var slots;if(lookingDown){toTileX=entityPos.x;toTileY=entityPos.y;targetOrientation=entity.entityOrientation;slots=TILE_SLOTS_DEFENSIVE}else{var delta=
ORIENTATION_DIFFS[entity.entityOrientation];toTileX=entityPos.x+delta.x;toTileY=entityPos.y+delta.y;targetOrientation=(entity.entityOrientation+2)%4;slots=TILE_SLOTS_OFFENSIVE}var result={toTileX:toTileX,toTileY:toTileY};var failureReason;if(toTileX>=0&&toTileY>=0&&toTileX<level.levelWidth&&toTileY<level.levelHeight){var tile=level.tiles[toTileX][toTileY];if(dropping||!tile.entity)slots=TILE_SLOTS_ALL;if(tile.tileType!=TILE_TYPE_SOLID){var targetDiff=ORIENTATION_DIFFS[targetOrientation];var targetX=
targetDiff.x;var targetY=targetDiff.y;if(dropping&&FEATURE_DROP_RANDOM_POSITIONS_ON_DEATH){targetX=random()-.5;targetY=random()-.5}var targetSlotKey=getBestAvailableTileSlotKey(slots,tile,targetX,targetY);if(targetSlotKey!=nil){result.toTilePosition=targetSlotKey;arrayForEachReverse(entity.dice,function(dice,index){if(dice&&dice.diceId==diceId){result.dice=dice;result.fromDiceSlot=index}});if(result.dice){if(tile.entity&&!dropping){var resourcesUsed=zeroResourceMap();var failed=getRollCost(entity,
result.dice.diceType,result.dice.diceLevel,resourcesUsed);if(failed)failureReason=PLAY_DICE_FAILURE_REASON_NO_RESOURCES;result.resourcesUsed=resourcesUsed}}else failureReason=PLAY_DICE_FAILURE_REASON_NOT_YOUR_DICE}else failureReason=PLAY_DICE_FAILURE_REASON_NO_ROOM}else failureReason=PLAY_DICE_FAILURE_REASON_BLOCKED}result.failureReason=failureReason;return result}function playDice(entity,canPlayDiceResult){var diceId=canPlayDiceResult.dice.diceId;var deltas;var success=!canPlayDiceResult.failureReason;
if(success){var face=floor(random()*6);var tile=level.tiles[canPlayDiceResult.toTileX][canPlayDiceResult.toTileY];var previousHealth=getEffectiveHealth(tile.entity,canPlayDiceResult.toTileX,canPlayDiceResult.toTileY);tile.dice[canPlayDiceResult.toTilePosition]={dice:canPlayDiceResult.dice,upturnedFace:face};entity.dice[canPlayDiceResult.fromDiceSlot]=nil;var ambientEffects=void 0;var targetEntity=tile.entity;if(targetEntity)ambientEffects=applyAmbientEffects(targetEntity,previousHealth);var playDelta=
{deltaType:LEVEL_DELTA_TYPE_PLAY_DICE,deltaData:{entity:entity,dice:canPlayDiceResult.dice,fromDiceSlot:canPlayDiceResult.fromDiceSlot,toFace:face,toTileX:canPlayDiceResult.toTileX,toTileY:canPlayDiceResult.toTileY,toTilePosition:canPlayDiceResult.toTilePosition},deltaChildren:ambientEffects};if(canPlayDiceResult.resourcesUsed){var resourcesUsed=canPlayDiceResult.resourcesUsed;mapForEach(resourcesUsed,function(resourceType,amount){entity.resourceCounts[resourceType]+=amount});deltas=[{deltaType:LEVEL_DELTA_TYPE_RESOURCE_CHANGE,
deltaData:{entity:entity,newEffectiveResourceCounts:levelUpdater.getEffectiveResourceCounts(entity),resourceDeltas:resourcesUsed},deltaChildren:[playDelta]}]}else deltas=[playDelta];var reverseOrientation=(entity.entityOrientation+2)%4;if(targetEntity&&targetEntity!=entity&&FEATURE_LOOK_AT_ATTACKER){if(targetEntity.entityOrientation!=reverseOrientation){var turnAction=turnToOrientation(targetEntity,reverseOrientation);turnAction.deltas[0].deltaChildren=deltas;deltas=turnAction.deltas}if(targetEntity.lookingDown){var lookAction=
look(targetEntity);lookAction.deltas[0].deltaChildren=deltas;deltas=lookAction.deltas}}}return{moveToNext:success,deltas:deltas}}var levelUpdater={updateLevel:function(){var deltas;if(entitiesInOrder.length){var entity_1=entitiesInOrder[currentTurnEntityIndex];var action_1;if(entity_1.dead){arraySplice(entitiesInOrder,currentTurnEntityIndex,1);currentTurnEntityIndex=currentTurnEntityIndex%entitiesInOrder.length}else{var moveToNext=void 0;if(entity_1.behaviorType==BEHAVIOR_TYPE_PLAYER){waitingOnInput=
inputQueue.length==0;if(!waitingOnInput){var input=arraySplice(inputQueue,0,1)[0];switch(input.inputTypeId){case INPUT_TYPE_LOOK_DOWN:action_1=look(entity_1,1);break;case INPUT_TYPE_MOVE_FORWARD:if(entity_1.lookingDown)action_1=look(entity_1);else action_1=moveForward(entity_1);break;case INPUT_TYPE_TURN:{var orientation_1=entity_1.entityOrientation;var inputDataTurn=input.inputData;if(inputDataTurn.fromOrientationHint!=nil)orientation_1=inputDataTurn.fromOrientationHint;orientation_1+=inputDataTurn.orientationDelta;
while(orientation_1<ORIENTATION_NORTH)orientation_1+=4;orientation_1=orientation_1%4;action_1=turnToOrientation(entity_1,orientation_1)}break;case INPUT_TYPE_COLLECT_DICE:action_1=collectDice(entity_1,canCollectDice(entity_1,input.inputData));break;case INPUT_TYPE_PLAY_DICE:action_1=playDice(entity_1,canPlayDice(entity_1,input.inputData.diceId,entity_1.lookingDown));break}}}else{var pos_1=levelGetPosition(level,entity_1);moveToNext=1;var diceCount_1=0;arrayForEach(entity_1.dice,function(dice){if(dice)diceCount_1++});
arrayForEach(ORIENTATION_DIFFS,function(diff,orientation){var x=pos_1.x+diff.x;var y=pos_1.y+diff.y;if(x>=0&&y>=0&&x<level.levelWidth&&y<level.levelHeight){var tile_1=level.tiles[x][y];if(tile_1.entity||diceCount_1==entity_1.diceSlots){if(!tile_1.entity||tile_1.entity.behaviorType==BEHAVIOR_TYPE_PLAYER)if(tile_1.entity&&orientation!=entity_1.entityOrientation)action_1=turnToOrientation(entity_1,orientation);else{var weightedDice_1=[];arrayForEach(entity_1.dice,function(dice){if(dice){var weight_1=
0;var offensiveness_1=0;arrayForEach(dice.symbols,function(symbols){arrayForEach(symbols,function(symbol){var symbolWeight=entity_1.personality.playDiceSymbolWeights[symbol];if(symbolWeight)weight_1+=symbolWeight;var symbolOffensiveness=DICE_SYMBOL_OFFENSIVENESS[symbol];offensiveness_1+=symbolOffensiveness})});arrayPush(weightedDice_1,{dice:dice,diceWeight:weight_1,offensive:offensiveness_1>0})}});var availableDice_1=[];var myTile=level.tiles[pos_1.x][pos_1.y];var inputs_1={};mapForEach(myTile.dice,
function(position,diceAndFace){if(diceAndFace){arrayPush(availableDice_1,diceAndFace);inputs_1[diceAndFace.dice.diceId]={diceId:diceAndFace.dice.diceId,tileX:pos_1.x,tileY:pos_1.y,dicePosition:position}}});mapForEach(tile_1.dice,function(position,diceAndFace){if(diceAndFace){arrayPush(availableDice_1,diceAndFace);inputs_1[diceAndFace.dice.diceId]={diceId:diceAndFace.dice.diceId,tileX:x,tileY:y,dicePosition:position}}});arrayForEach(availableDice_1,function(diceAndFace){var currentValue=0;var otherValue=
0;var dice=diceAndFace.dice;var offensiveness=0;var collectBonus=0;var isResourceDice=1;arrayForEach(dice.symbols,function(symbols,side){arrayForEach(symbols,function(symbol){var symbolWeight=entity_1.personality.playDiceSymbolWeights[symbol];isResourceDice=isResourceDice&&isSymbolResource(symbol);if(side==diceAndFace.upturnedFace){currentValue+=symbolWeight;collectBonus+=entity_1.personality.collectDiceSymbolWeights[symbol]}else otherValue+=symbolWeight;var symbolOffensiveness=DICE_SYMBOL_OFFENSIVENESS[symbol];
offensiveness+=symbolOffensiveness})});otherValue/=5;var weight;if(isResourceDice)weight=0;else weight=otherValue-currentValue;var input=inputs_1[dice.diceId];if(pos_1.x==input.tileX&&pos_1.y==input.tileY)weight+=collectBonus;if(dice.owner!=entity_1.id)weight=-weight;arrayPush(weightedDice_1,{dice:dice,diceWeight:weight,offensive:offensiveness>0,collect:1})});weightedDice_1.sort(function(wd1,wd2){return wd2.diceWeight-wd1.diceWeight});randomizeArray(mathRandomNumberGenerator,weightedDice_1,entity_1.personality.randomness);
arrayForEach(weightedDice_1,function(weightedDice){var dice=weightedDice.dice;if(!action_1&&weightedDice.diceWeight>=0)if(weightedDice.collect){var input=inputs_1[dice.diceId];var canCollectDiceResult=canCollectDice(entity_1,input);if(!action_1&&!canCollectDiceResult.failureReason)action_1=collectDice(entity_1,canCollectDiceResult)}else if(!weightedDice.offensive||tile_1.entity){var canPlayDiceResult=canPlayDice(entity_1,dice.diceId,!weightedDice.offensive);if(!canPlayDiceResult.failureReason)action_1=
playDice(entity_1,canPlayDiceResult)}})}}else mapForEach(tile_1.dice,function(position,diceAndFace){if(!action_1&&diceAndFace){var canCollectDiceResult=canCollectDice(entity_1,{diceId:diceAndFace.dice.diceId,tileX:x,tileY:y,dicePosition:position});if(!canCollectDiceResult.failureReason){action_1=collectDice(entity_1,canCollectDiceResult);action_1.moveToNext=true}}})}})}if(action_1&&action_1.deltas){moveToNext=action_1.moveToNext;deltas=action_1.deltas}if(moveToNext)currentTurnEntityIndex=(currentTurnEntityIndex+
1)%entitiesInOrder.length}}else waitingOnInput=1;return{awaitingInput:waitingOnInput,deltas:deltas}},queueInput:function(input){var localWaitingOnInput=waitingOnInput;waitingOnInput=0;arrayPush(inputQueue,input);return localWaitingOnInput},getEffectiveResourceCounts:function(entity){var effectiveResourceCounts=zeroResourceMap();var entityPos=levelGetPosition(level,entity);if(entityPos){var tile_2=level.tiles[entityPos.x][entityPos.y];mapForEach(entity.resourceCounts,function(key,value){effectiveResourceCounts[key]+=
value;mapForEach(tile_2.dice,function(position,diceAndFace){if(diceAndFace)arrayForEach(diceAndFace.dice.symbols[diceAndFace.upturnedFace],function(symbol){var symbolResourceCounts=DICE_SYMBOL_RESOURCE_VALUES[key];if(symbolResourceCounts){var symbolResourceCount=symbolResourceCounts[symbol];if(symbolResourceCount<0)effectiveResourceCounts[key]+=symbolResourceCount}})})})}return effectiveResourceCounts},getEffectiveHealth:function(entity){var entityPos=levelGetPosition(level,entity);return getEffectiveHealth(entity,
entityPos.x,entityPos.y)}};return levelUpdater}
function levelPopulatorTileMazeFactory(roomChance,bendiness,doorChance,deadendChance){return function(game,rng,tiles,width,height,depth,tileDefinition){function countFloors(x,y,decrementDoors){return countSurroundingTiles(tiles,width,height,x,y,function(tile){var doorCount=doorCounts[tile.tileName];if(decrementDoors&&doorCount)doorCounts[tile.tileName]--;return tile.tileType==TILE_TYPE_FLOOR&&!doorCount?1:0})}function getRandomSymbol(maxValue,diceHint,diceType,persistence,preferredResourceTypeHint){var categories=
DICE_TYPE_HINT_SYMBOL_COSTS[diceType];var costs=categories[diceHint%categories.length];var indices=[];arrayForEach(costs,function(v,i){if(v!=nil)arrayPush(indices,i)});var result;while(persistence){var index=rng(indices.length);var symbol=indices[index];var cost=costs[symbol];if(cost<=maxValue&&(!result||result.cost<cost)){if(!diceType&&preferredResourceTypeHint&&isSymbolResource(symbol)&&symbol!=preferredResourceTypeHint)symbol=DICE_SYMBOL_ATTACK;result={symbol:symbol,cost:cost}}persistence--}return result}
function getDiceLevel(valueCount){return max(0,floor((valueCount-.4)/2-depth*.1))}function createRandomDice(maxValueCount,maxSideValueCount,diceHint,diceType,ownerId){var maxLevel=getDiceLevel(maxValueCount);var preferredResourceType;if(!maxLevel){preferredResourceType=diceType;diceType=DICE_TYPE_NEUTRAL}var symbols=[];var empty=1;var totalValueCount=0;countForEach(3,function(i){var faceSymbols=[];var sideValueCount;if(i==2)sideValueCount=maxValueCount;else sideValueCount=rng(maxValueCount);sideValueCount=
min(maxSideValueCount,sideValueCount);maxValueCount-=sideValueCount;totalValueCount+=sideValueCount;while(faceSymbols.length<4&&sideValueCount>0){var symbolAndCost=getRandomSymbol(sideValueCount,diceHint,diceType,ceil(sideValueCount*2),preferredResourceType);empty=empty&&!symbolAndCost;if(symbolAndCost){sideValueCount-=symbolAndCost.cost;arrayPush(faceSymbols,symbolAndCost.symbol)}else break}arrayPushAll(symbols,[faceSymbols,faceSymbols])});var level=getDiceLevel(totalValueCount);if(!empty){var dice=
{diceId:game.nextEntityId++,diceLevel:level,owner:ownerId,symbols:symbols,diceType:diceType};return dice}}var doorCounts={};var wallCount=width*height;var roomCount=rng(roomChance*wallCount);var buffer=3;var level={tiles:tiles,levelWidth:width,levelHeight:height};var _loop_1=function(){var rw=rng(width/3)+2;var rh=rng(height/3)+2;var rx=rng(width-rw-buffer);var ry=rng(height-rh-buffer);var badTile=levelFindTile(level,function(tile,x,y){return tile.tileType==TILE_TYPE_FLOOR&&x>=rx-buffer&&y>=ry-buffer&&
x<rx+rw+buffer&&y<ry+rh+buffer});if(!badTile){var room=""+roomCount;var doorCount=rng((rw+rh)*doorChance)+1;doorCounts[room]=doorCount;for(var x=rx;x<rx+rw;x++)for(var y=ry;y<ry+rh;y++){var tile=tiles[x][y];tile.tileType=TILE_TYPE_FLOOR;tile.tileName=room}}roomCount--};while(roomCount>0)_loop_1();var startX=width-1;var startY=height-1;var pathSoFar=[{x:startX,y:startY,directions:copyArray(ORIENTATION_ALL)}];while(pathSoFar.length){var step=pathSoFar[0];tiles[step.x][step.y].tileType=TILE_TYPE_FLOOR;
var index=void 0;if(rng()>bendiness)index=step.preferredIndex;step.preferredIndex=nil;if(index==nil)index=rng(step.directions.length);var orientation_2=arraySplice(step.directions,index,1)[0];if(!step.directions.length)arraySplice(pathSoFar,0,1);var delta=ORIENTATION_DIFFS[orientation_2];var tx=step.x+delta.x;var ty=step.y+delta.y;if(tx>=0&&tx<width&&ty>=0&&ty<height&&countFloors(tx,ty)<2){countFloors(tx,ty,1);arraySplice(pathSoFar,0,0,{x:tx,y:ty,directions:copyArray(ORIENTATION_ALL),preferredIndex:index})}}var deadends=
[];var floorTiles=[];levelFindTile(level,function(tile,x,y){var p={x:x,y:y};if(countFloors(x,y)==1)arrayPush(deadends,p);if(tile.tileType==TILE_TYPE_FLOOR)arrayPush(floorTiles,p)});randomizeArray(rng,deadends);randomizeArray(rng,floorTiles);arrayForEach(tileDefinition,function(tileDefinition){var tile;switch(tileDefinition.tileType){case TILE_TYPE_PIT:{var tileX=void 0;var tileY=void 0;do{tileX=rng(width);tileY=rng(height);tile=tiles[tileX][tileY]}while(tile.tileType!=TILE_TYPE_SOLID||!countFloors(tileX,
tileY))}break;default:{var tileX=void 0;var tileY=void 0;if(deadends.length){var point=arraySplice(deadends,0,1)[0];tileX=point.x;tileY=point.y}else{tileX=rng(width);tileY=rng(height)}tile=tiles[tileX][tileY]}break}tile.tileType=tileDefinition.tileType;tile.tileName=tileDefinition.tileName;tile.featureType=tileDefinition.featureType;if(FEATURE_TUTORIAL)tile.scribbles=tileDefinition.scribbles;if(tileDefinition.boss&&FEATURE_BOSS){var bossDice_1=[];var bossId_1=game.nextEntityId++;mapForEach(DICE_TYPE_HINT_SYMBOL_COSTS,
function(diceType,hintsToCosts){mapForEach(hintsToCosts,function(hint,costs){var maxValueCount;if(diceType==DICE_TYPE_NEUTRAL)maxValueCount=6;else maxValueCount=30;var dice=createRandomDice(maxValueCount,100,hint,diceType,bossId_1);dice.diceLevel=max(0,dice.diceLevel-1);arrayPush(bossDice_1,dice)})});var boss={id:bossId_1,behaviorType:BEHAVIOR_TYPE_MONSTER,diceSlots:bossDice_1.length,dice:bossDice_1,healthSlots:4,personality:{collectDiceSymbolWeights:DICE_SYMBOL_COLLECT_DESIRABILITY,playDiceSymbolWeights:DICE_SYMBOL_PLAY_DESIRABILITY,
randomness:0},entityOrientation:ORIENTATION_EAST,resourceCounts:zeroResourceMap(),entityType:ENTITY_TYPE_BOSS};tile.entity=boss}});arrayForEachReverse(deadends,function(deadend){var remove;if(countFloors(deadend.x,deadend.y)==1&&rng()>deadendChance)arrayForEach(ORIENTATION_DIFFS,function(diff){var fromx=deadend.x+diff.x;var fromy=deadend.y+diff.y;var tox=deadend.x-diff.x;var toy=deadend.y-diff.y;if(fromx>=0&&fromx<width&&tox>=0&&tox<width&&fromy>=0&&fromy<height&&toy>=0&&toy<height){var to=tiles[tox][toy];
var from=tiles[fromx][fromy];if(to.tileType==TILE_TYPE_SOLID&&from.tileType==TILE_TYPE_FLOOR){to.tileType=TILE_TYPE_FLOOR;remove=1}}});return remove});var attackType=rng(4);var defendType=rng(4);var monsterCount=max(0,depth-1);monsterCount+=rng(sqrt(monsterCount));arrayForEachReverse(floorTiles,function(floorTile){if(monsterCount){var tile=tiles[floorTile.x][floorTile.y];if(!tile.entity){var entityLevel=rng(depth-1)+1;var healthSlots=floor(sqrt(entityLevel));var diceSlots=entityLevel-rng(entityLevel>>
1)+1;var diceCount=diceSlots-rng(diceSlots>>1);var collectDiceSymbolWeights_1=[];var playDiceSymbolWeights_1=[];arrayForEach(DICE_SYMBOL_PLAY_DESIRABILITY,function(baseDesirability,index){arrayPush(playDiceSymbolWeights_1,baseDesirability+baseDesirability*rng());arrayPush(collectDiceSymbolWeights_1,DICE_SYMBOL_COLLECT_DESIRABILITY[index]+rng()/2)});var dice=[];var entityId=game.nextEntityId++;var entityType=void 0;var diceHintOffset=void 0;var scribbles=void 0;if(depth<=2){diceCount=3;diceHintOffset=
0;entityType=DICE_TYPE_NEUTRAL;if(FEATURE_TUTORIAL)scribbles=["throw","attack","die"]}else{if(diceCount>3)diceHintOffset=rng(diceCount);else diceHintOffset=4;entityType=rng(4)}var hasLeveledDice=void 0;var hasResourceDice=void 0;while(diceCount){diceCount--;var diceHint_1=diceHintOffset+diceCount;var maxValueCount=rng(diceCount*1.7)+2;var maxDiceSideValue=max(1,getDiceLevel(maxValueCount)+floor(sqrt(depth)-1));var newDice=createRandomDice(maxValueCount,maxDiceSideValue,diceHint_1,entityType,entityId);
hasLeveledDice=hasLeveledDice||newDice.diceLevel;if(newDice.diceLevel&&newDice.diceType)collectDiceSymbolWeights_1[newDice.diceType]+=newDice.diceLevel*.4;if(newDice)arrayPush(dice,newDice)}if(hasLeveledDice&&!hasResourceDice){diceSlots++;var resourceDice=createRandomDice(2.4,2,entityType,DICE_TYPE_NEUTRAL,entityId);arrayPush(dice,resourceDice)}var entity={behaviorType:BEHAVIOR_TYPE_MONSTER,dice:dice,diceSlots:diceSlots+1,resourceCounts:zeroResourceMap(),entityOrientation:rng(4),healthSlots:healthSlots,
id:entityId,personality:{collectDiceSymbolWeights:collectDiceSymbolWeights_1,playDiceSymbolWeights:playDiceSymbolWeights_1,randomness:rng()/depth},entityType:ENTITY_TYPE_MONSTER};tile.entity=entity;if(FEATURE_TUTORIAL)tile.scribbles=scribbles;monsterCount--}}return monsterCount});var secretCount=min(rng(2),deadends.length);var treasurePileCount=rng(sqrt(depth))+3;var diceHint=3+depth;arrayPushAll(deadends,floorTiles);arrayForEach(deadends,function(deadend){var tile=tiles[deadend.x][deadend.y];var treasures=
min(treasurePileCount,max(rng(sqrt(depth)),1));while(treasures>0&&tile.tileType==TILE_TYPE_FLOOR&&!tile.entity&&!tile.featureType){var diceType=void 0;var maxValueCount=void 0;var maxSideValueCount=void 0;var scribbles=void 0;if(depth<3){diceType=DICE_TYPE_NEUTRAL;maxValueCount=2.4;maxSideValueCount=1;secretCount=0;if(FEATURE_TUTORIAL)scribbles=NEUTRAL_DICE_HINT_SCRIBBLES[diceHint%NEUTRAL_DICE_HINT_SCRIBBLES.length]}else{diceHint=rng(99);diceType=rng(4);var maxLevel=sqrt(rng(depth))+1;maxValueCount=
1+rng(maxLevel*2);maxSideValueCount=1+maxLevel}if(secretCount){secretCount--;tile.tileType=TILE_TYPE_HIDDEN;maxValueCount+=2;maxSideValueCount++}if(!tile.scribbles&&FEATURE_TUTORIAL)tile.scribbles=scribbles;var dice=createRandomDice(maxValueCount,maxSideValueCount,diceHint,diceType);diceHint++;if(dice){var slot=getBestAvailableTileSlotKey(TILE_SLOTS_ALL,tile,0,0);tile.dice[slot]={dice:dice,upturnedFace:rng(6)}}treasures--}treasurePileCount--})}}
function playStateFactory(audioContext,gameService,levelPopulator,homeStateFactory){return function(stateTypeId,data){function getListenerLocation(){return cameraEntityRender.localTransforms}var entityRenderSoundEffects={hurt:webAudioToneSoundEffectFactory(audioContext,getListenerLocation,"sawtooth",300,-100,100,.01,.05,.1,.3),diceThrow:webAudioToneSoundEffectFactory(audioContext,getListenerLocation,"sine",1E3,-400,100,.04,.1,.2,.5),diceLand:webAudioToneSoundEffectFactory(audioContext,getListenerLocation,
"square",100,100,50,.01,.05,.1,.2),diceCollect:webAudioToneSoundEffectFactory(audioContext,getListenerLocation,"sine",500,999,100,.04,.1,.2,.5),stepFailed:webAudioToneSoundEffectFactory(audioContext,getListenerLocation,"square",200,100,10,.05,.01,.04,.1),powerup:FEATURE_SOUND_VIBRATO?webAudioVibratoSoundFactory(audioContext,getListenerLocation,600,1E3,14,.8):webAudioToneSoundEffectFactory(audioContext,getListenerLocation,"triangle",100,800,100,.4,.1,.1,.6),fall:webAudioToneSoundEffectFactory(audioContext,
getListenerLocation,"square",800,100,100,.01,.3,.3,.6)};var game=data.game;var levelId;if(data.playerTransition){levelId=data.playerTransition.entryLocation.levelId;if(data.playerTransition.entryLocation.tileName=="x"){game.gameState=GAME_STATE_WON;gameService.saveLevel(game,nil);return homeStateFactory(STATE_TYPE_HOME,{justExited:1})}}else levelId=game.playerLevelId;var level=gameService.getLevel(game,levelId);if(!level){var rng=mathRandomNumberGenerator;var squareSide=7+(levelId>>1);var area=squareSide*
squareSide+levelId;var width=squareSide+rng(squareSide/4)-rng(squareSide/4);var height=ceil(area/width);var tiles=create2DArray(width,height,function(x,y){var tile={tileType:TILE_TYPE_SOLID,dice:{}};return tile});var features_1=[];var numEntrances_1=max(1,floor(sqrt(levelId/2)));var numExits_1=floor(sqrt(1+levelId/2));if(levelId==13){numExits_1=0;arrayPush(features_1,{tileType:TILE_TYPE_PIT,tileName:"x",boss:1})}if(levelId<FEATURE_TYPE_COUNT){var featureType=FEATURE_TYPE_ALL[levelId];arrayPush(features_1,
{featureType:featureType,tileType:TILE_TYPE_FLOOR,scribbles:FEATURE_TYPE_SCRIBBLES[featureType]})}else{var featureType=void 0;if(data.playerTransition.entity.healthSlots<floor(levelId/4+1))featureType=FEATURE_TYPE_BONUS_HEALTH;else featureType=FEATURE_TYPE_BONUS_DICE_SLOT;arrayPush(features_1,{featureType:featureType,tileType:TILE_TYPE_FLOOR})}countForEach(max(numExits_1,numEntrances_1),function(count){var featureType;if(count<numExits_1)arrayPush(features_1,{tileType:TILE_TYPE_PIT,tileName:""+(levelId+
1)+""+count,featureType:featureType});if(count<numEntrances_1)arrayPush(features_1,{tileType:TILE_TYPE_ROOFLESS,tileName:""+levelId+""+count,scribbles:levelId==1?["find","a","way","out"]:nil})});levelPopulator(game,rng,tiles,width,height,levelId,features_1);level=gameService.createLevel(game,width,height,tiles)}var viewer;var queuedLevelDeltas;if(data.playerTransition){var tileX_1=0;var tileY_1=0;var tile=levelFindTile(level,function(tile,x,y){if(tile.tileName==data.playerTransition.entryLocation.tileName){tileX_1=
x;tileY_1=y}});tile=level.tiles[tileX_1][tileY_1];viewer=data.playerTransition.entity;tile.entity=viewer;if(FEATURE_AUTO_ORIENT_PLAYER)arrayForEach(ORIENTATION_DIFFS,function(diff,orientation){var tx=tileX_1+diff.x;var ty=tileY_1+diff.y;if(tx>=0&&ty>=0&&tx<level.levelWidth&&ty<level.levelHeight){var t=level.tiles[tx][ty];if(t.tileType!=TILE_TYPE_SOLID)viewer.entityOrientation=orientation}});queuedLevelDeltas=[{deltaType:LEVEL_DELTA_TYPE_DROP_IN,deltaData:{entity:viewer}}]}else{var tile=levelFindTile(level,
function(tile){return tile.entity&&tile.entity.behaviorType==BEHAVIOR_TYPE_PLAYER});viewer=tile.entity;viewer.lookingDown=0}if(FEATURE_PRINT_LEVEL){console.log("level "+levelId);for(var y=0;y<level.levelHeight;y++){var s=""+y+":";for(var x=0;x<level.levelWidth;x++){var tile=level.tiles[x][y];if(tile.tileName)s+=tile.tileName;else s+=tile.tileType==TILE_TYPE_SOLID?"#":tile.tileType==TILE_TYPE_FLOOR?".":tile.tileType.toString()}console.log(s)}}game.playerLevelId=level.levelId;gameService.saveLevel(game,
level);var tileRenders;var entityRenders;var cameraEntityRender;var context;var cameraProjectionMatrix;var updateAnimation;var animationFrameRequest;var surfaceRenderParams;var diceTextureCoordinates;var diceRenderParams;var halfDiceSize=.075;var featurePotionBaseHeight=.14;var healthRenderParams;var featurePotionRenderParams;var textures=[];var queuedStateChangeData;var levelUpdater=createLevelUpdater(game,level);var canvas=getElemById("c");var inventory=getElemById("i");var status=getElemById("s");
function queueInput(input){if(updateAnimation){updateAnimation(0,1);updateAnimation=nil}if(!viewer.dead)levelUpdater.queueInput(input);else playState.stateListener(STATE_TYPE_HOME)}function handleSelect(x,y){var offscreenFramebufferWidth=canvas.clientWidth;var offscreenFramebufferHeight=canvas.clientHeight;renderOffscreen(offscreenFramebufferWidth,offscreenFramebufferHeight,function(){draw(1);var pixels=new Uint8Array(4);context.readPixels(x,offscreenFramebufferHeight-y,1,1,context.RGBA,context.UNSIGNED_BYTE,
pixels);var id=0;countForEach(3,function(i){id=id<<8|pixels[i]});levelFindTile(level,function(tile,x,y){var result;for(var position in tile.dice){var diceAndFace=tile.dice[position];if(diceAndFace){result=diceAndFace.dice.diceId==id;if(result){queueInput({inputTypeId:INPUT_TYPE_COLLECT_DICE,inputData:{diceId:id,tileX:x,tileY:y,dicePosition:position}});return result}}}var entity=tile.entity;var input={inputTypeId:INPUT_TYPE_NONE};if(entity==viewer)for(var _i=0,_a=entity.dice;_i<_a.length;_i++){var dice=
_a[_i];var result_1=dice&&dice.diceId==id;if(result_1){input={inputTypeId:INPUT_TYPE_PLAY_DICE,inputData:{diceId:id,owner:entity}};return result_1}}queueInput(input)})})}function consume(t,levelDeltas){var animation;if(levelDeltas){var animations_1=[];arrayForEach(levelDeltas,function(levelDelta){var levelDeltaAnimations=[];mapForEach(entityRenders,function(entityId,entityRender){var animation=entityRender.consume(t,levelDelta);if(animation)arrayPush(levelDeltaAnimations,animation)});switch(levelDelta.deltaType){case LEVEL_DELTA_TYPE_DIE:var dieData=
levelDelta.deltaData;delete entityRenders[dieData.entity.id];break;case LEVEL_DELTA_TYPE_CHANGE_STATE:queuedStateChangeData=levelDelta.deltaData;break}var levelDeltaAnimation=animationCompositeFactory(levelDeltaAnimations);if(levelDelta.deltaChildren)levelDeltaAnimation=animationChainedProxyFactory(levelDeltaAnimation,function(t){return consume(t,levelDelta.deltaChildren)});arrayPush(animations_1,levelDeltaAnimation)});animation=animationCompositeFactory(animations_1)}return animation}function animate(t){if(updateAnimation){var done=
updateAnimation(t);if(done)updateAnimation=null}else update(t);mapForEach(entityRenders,function(key,entityRender){entityRender.update(t)});draw();if(queuedStateChangeData)playState.stateListener(queuedStateChangeData.stateTypeId,queuedStateChangeData.stateData)}function update(t){var levelUpdate=levelUpdater.updateLevel();if(viewer.dead)game.gameState=GAME_STATE_DEAD;if(levelUpdate.deltas)gameService.saveLevel(game,level);updateAnimation=consume(t,levelUpdate.deltas);if(!updateAnimation&&!levelUpdate.awaitingInput&&
!viewer.dead)update(t)}function resize(){var width=canvas.clientWidth;var height=canvas.clientHeight;canvas.width=width;canvas.height=height;context.viewport(0,0,width,height);cameraProjectionMatrix=matrixPerspective4(pi/3,width/height,.1,100)}function redraw(){var gl=context;var rng=mathRandomNumberGenerator;var groutWidth=rng(3)+1;var textureDimension=256;var brickRounding=rng(6);var colors=createRandomWallColors(rng);var bricksAcross=(rng(2)+2)*2;var bricksDown=(rng(3)+2)*2;var roofTilesAcross=
rng(4)+1;var roofTilesDown=rng(4)+1;if(bricksAcross>=bricksDown)bricksAcross=bricksDown-1;var blankTexture=webglCanvasToTexture(gl,createPickTexture(0));arrayPush(textures,blankTexture);updateAnimation=null;entityRenders={};create2DArray(level.levelWidth,level.levelHeight,function(x,y,tileRenders2){tileRenders=tileRenders2;var tile=level.tiles[x][y];var childRenders={};if(tile.tileType!=TILE_TYPE_SOLID){var hole=tile.tileType==TILE_TYPE_ROOFLESS||tile.tileType==TILE_TYPE_PIT;var text1=void 0;var text2=
void 0;var yRotation=0;var upperColor=colors.wallUpper;switch(tile.tileType){case TILE_TYPE_PIT:text1=["\u25b2"];text2=["\u25bc"];break;case TILE_TYPE_HIDDEN:var character=DICE_SYMBOL_CHARACTERS[rng(DICE_SYMBOL_CHARACTERS.length)];var text_1=[character];countForEach(bricksAcross*bricksDown/2,function(){arrayPush(text_1," ")});randomizeArray(rng,text_1);text1=text_1;text2=text_1;yRotation=pi;upperColor=colors.wallLower;break;default:if(tile.scribbles&&FEATURE_TUTORIAL){text1=[];var spaces_1=[];countForEach(((bricksAcross-
.5)*bricksDown-tile.scribbles.length)/2,function(){spaces_1.push("")});arrayPushAll(text1,spaces_1);arrayPushAll(text1,tile.scribbles);arrayPushAll(text1,spaces_1);text2=text1}}var wallTexture1=webglCanvasToTexture(gl,createRepeatingBrickPattern(rng,textureDimension,textureDimension,bricksAcross,bricksDown,.5,0,upperColor,colors.wallLower,brickRounding,groutWidth,colors.grout,text1));var wallTexture2=webglCanvasToTexture(gl,createRepeatingBrickPattern(rng,textureDimension,textureDimension,bricksAcross,
bricksDown,.5,.5,upperColor,colors.wallLower,brickRounding,groutWidth,colors.grout,text2));var westSolid=x==0||isTileTypeSolid(level.tiles[x-1][y].tileType);if(westSolid||yRotation)childRenders["w"]=shapeRenderFactory([matrixTranslate4(-.5,.5,0),matrixRotateZ4(piOn2+(westSolid?0:yRotation)),matrixRotateY4(piOn2)],surfaceRenderParams,wallTexture1,blankTexture);var eastSolid=x==level.levelWidth-1||isTileTypeSolid(level.tiles[x+1][y].tileType);if(eastSolid||yRotation)childRenders["e"]=shapeRenderFactory([matrixTranslate4(.5,
.5,0),matrixRotateZ4(-piOn2+(eastSolid?0:yRotation)),matrixRotateY4(-piOn2)],surfaceRenderParams,wallTexture1,blankTexture);var northSolid=y==0||isTileTypeSolid(level.tiles[x][y-1].tileType);if(northSolid||yRotation)childRenders["n"]=shapeRenderFactory([matrixTranslate4(0,.5,-.5),matrixRotateX4(-piOn2+(northSolid?0:yRotation))],surfaceRenderParams,wallTexture2,blankTexture);var southSolid=y==level.levelHeight-1||isTileTypeSolid(level.tiles[x][y+1].tileType);if(southSolid||yRotation)childRenders["s"]=
shapeRenderFactory([matrixTranslate4(0,.5,.5),matrixRotateX4(piOn2+(southSolid?0:yRotation)),matrixRotateY4(pi)],surfaceRenderParams,wallTexture2,blankTexture);var floorTexture=webglCanvasToTexture(gl,createRepeatingBrickPattern(rng,textureDimension,textureDimension,1,1,0,0,colors.floor,colors.floor,brickRounding*4,groutWidth*3,colors.grout,tile.tileType==TILE_TYPE_ROOFLESS?[level.levelId]:nil));if(tile.tileType==TILE_TYPE_PIT){childRenders["W"]=shapeRenderFactory([matrixTranslate4(.5,-.5,0),matrixRotateZ4(-piOn2),
matrixRotateY4(piOn2)],surfaceRenderParams,wallTexture2);childRenders["E"]=shapeRenderFactory([matrixTranslate4(-.5,-.5,0),matrixRotateZ4(piOn2),matrixRotateY4(-piOn2)],surfaceRenderParams,wallTexture2);childRenders["N"]=shapeRenderFactory([matrixTranslate4(0,-.5,.5),matrixRotateX4(piOn2)],surfaceRenderParams,wallTexture1);childRenders["S"]=shapeRenderFactory([matrixTranslate4(0,-.5,-.5),matrixRotateX4(-piOn2),matrixRotateY4(pi)],surfaceRenderParams,wallTexture1)}else childRenders["f"]=shapeRenderFactory([matrixRotateY4(pi/
2*rng(4))],surfaceRenderParams,floorTexture);var ceilingTexture=webglCanvasToTexture(gl,createRepeatingBrickPattern(rng,textureDimension,textureDimension,roofTilesAcross,roofTilesDown,1/(rng(roofTilesAcross)+1),0,colors.wallUpper,colors.wallUpper,brickRounding,groutWidth,colors.grout));if(tile.tileType==TILE_TYPE_ROOFLESS){childRenders["W"]=shapeRenderFactory([matrixTranslate4(.5,1.5,0),matrixRotateZ4(-piOn2),matrixRotateY4(piOn2)],surfaceRenderParams,wallTexture2);childRenders["E"]=shapeRenderFactory([matrixTranslate4(-.5,
1.5,0),matrixRotateZ4(piOn2),matrixRotateY4(-piOn2)],surfaceRenderParams,wallTexture2);childRenders["N"]=shapeRenderFactory([matrixTranslate4(0,1.5,.5),matrixRotateX4(piOn2)],surfaceRenderParams,wallTexture1);childRenders["S"]=shapeRenderFactory([matrixTranslate4(0,1.5,-.5),matrixRotateX4(-piOn2),matrixRotateY4(pi)],surfaceRenderParams,wallTexture1)}else childRenders["c"]=shapeRenderFactory([matrixTranslate4(0,1,0),matrixRotateX4(pi)],surfaceRenderParams,ceilingTexture);var featureTexture=void 0;
if(tile.featureType){var colors_1=FEATURE_TYPE_COLORS[tile.featureType];var canvas_1=createRepeatingBrickPattern(rng,64,256,1,2,0,0,colors_1.upper,colors_1.lower,4,10,"#fff",[FEATURE_TYPE_NAMES[tile.featureType]," "]);featureTexture=webglCanvasToTexture(gl,canvas_1);var yoffset=featurePotionBaseHeight;if(tile.tileType==TILE_TYPE_PIT)yoffset+=.3;var render=shapeRenderFactory([matrixTranslate4(0,yoffset,0)],featurePotionRenderParams,featureTexture);childRenders["b"]=render}arrayPushAll(textures,[wallTexture1,
wallTexture2,ceilingTexture,floorTexture,featureTexture])}if(tile.entity){var render=createEntityRender(tile.entity,x,y);entityRenders[tile.entity.id]=render;if(tile.entity.behaviorType==BEHAVIOR_TYPE_PLAYER)cameraEntityRender=render}mapForEach(tile.dice,function(key,diceAndFace){if(diceAndFace){var slot=TILE_SLOTS_ALL[key];var render=createRestingTileDiceRender(diceAndFace.dice,slot.dx,slot.dy,diceAndFace.upturnedFace,slot.slotRotation);childRenders[key]=render}});var transform=matrixTranslate4(x,
0,y);var tileRender=compositeRenderFactory([transform],childRenders);return tileRender});draw()}function draw(usePickTextures){var gl=context;gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);if(cameraEntityRender){var cameraPosition=matrixInvert4(cameraEntityRender.bodyPosition);var cameraRotation=matrixInvert4(cameraEntityRender.bodyRotation);var transformStack_1=[cameraProjectionMatrix,cameraEntityRender.headRotation,cameraRotation,cameraPosition];levelFindTile(level,function(tile,x,y){var tileRender=
tileRenders[x][y];tileRender.draw(gl,transformStack_1,usePickTextures)});mapForEach(entityRenders,function(key,entityRender){entityRender.draw(gl,transformStack_1,usePickTextures)})}}function createEntityRender(entity,x,y){var rotation=matrixRotateY4(ORIENTATION_ANGLES[entity.entityOrientation]);var position=matrixTranslate4(x,.5,y);var diceRenders={};arrayForEach(entity.dice,function(dice,index){if(dice){var diceRender=createEntityDiceRender(dice,index,entity.dice.length);diceRenders[dice.diceId]=
{render:diceRender,index:index}}});var healthCount=entity.healthSlots;var healthRenders=[];while(healthCount){healthCount--;var healthRender=createHealthRender(entity.entityType);arrayPush(healthRenders,healthRender)}return entityRenderFactory(entity,position,rotation,healthRenders,diceRenders,tileRenders,redrawInventory,halfDiceSize,levelUpdater.getEffectiveResourceCounts(entity),levelUpdater.getEffectiveHealth(entity),entityRenderSoundEffects)}function createHealthRender(entityType){var rng=function(){return 0};
var color=ENTITY_TYPE_COLORS[entityType];var canvas=createRepeatingBrickPattern(rng,32,64,1,1,0,0,"#aaa",color,0,0,"#fff");var texture=webglCanvasToTexture(context,canvas);arrayPush(textures,texture);var transforms=[];return shapeRenderFactory(transforms,healthRenderParams,texture)}function createDiceRender(dice,transformations){var canvas=createDiceTexture(512,256,diceTextureCoordinates,dice);var texture=webglCanvasToTexture(context,canvas);arrayPush(textures,texture);var pickTexture=webglCanvasToTexture(context,
createPickTexture(dice.diceId));return shapeRenderFactory(transformations,diceRenderParams,texture,pickTexture)}function createEntityDiceRender(dice,index,count){var transformations=[];return createDiceRender(dice,transformations)}function createRestingTileDiceRender(dice,x,y,face,yAngle){var yRotation=matrixRotateY4(yAngle);var rotation=matrixCopy4(DICE_FACE_ROTATIONS[face].matrix);var position=matrixTranslate4(x,halfDiceSize,y);return createDiceRender(dice,[position,yRotation,rotation])}function redrawInventory(){var render=
cameraEntityRender;var entity=render.entity;inventory.innerHTML="";status.innerHTML="";inventory.appendChild(status);var healthCount=render.effectiveHealth;while(healthCount>0){healthCount--;var dimension_2=min(inventory.clientWidth,inventory.clientHeight)>>2;var healthRender=render.healthRenders[healthCount];if(!healthRender){healthRender=createHealthRender(entity.entityType);render.healthRenders[healthCount]=healthRender}var canvas_2=renderToCanvas(healthRender,dimension_2,dimension_2,halfDiceSize,
0,0);status.appendChild(canvas_2)}arrayForEach(RESOURCE_TYPE_ALL,function(resourceType){var value=render.effectiveResourceCounts[resourceType];if(!value)value=0;var div=createElement("h2",{"class":"r"+resourceType});var t="\u25ba ";while(value)if(value>0){t+="\u25cf";value--}else{t+="\u25cb";value++}div.innerText=t;status.appendChild(div)});countForEach(entity.diceSlots,function(i){var dice=entity.dice[i];var slotRender=createElement("div",{"class":"t"});inventory.appendChild(slotRender);var canvasWidth=
slotRender.clientWidth;var canvasHeight=slotRender.clientHeight;if(dice){var diceRender=render.diceRenders[dice.diceId].render;var canvas_3=renderToCanvas(diceRender,canvasWidth,canvasHeight,halfDiceSize,pi/5,pi/4);canvas_3.onclick=function(){var data={diceId:dice.diceId,owner:entity};queueInput({inputTypeId:INPUT_TYPE_PLAY_DICE,inputData:data})};slotRender.appendChild(canvas_3)}})}function renderOffscreen(offscreenFramebufferWidth,offscreenFramebufferHeight,renderOffscreenAndConsume){var gl=context;
var offscreenFramebuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,offscreenFramebuffer);var offscreenTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,offscreenTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,offscreenFramebufferWidth,offscreenFramebufferHeight,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var offscreenRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,offscreenRenderbuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,offscreenFramebufferWidth,
offscreenFramebufferHeight);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,offscreenTexture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,offscreenRenderbuffer);gl.viewport(0,0,offscreenFramebufferWidth,offscreenFramebufferHeight);renderOffscreenAndConsume();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.deleteFramebuffer(offscreenFramebuffer);gl.deleteTexture(offscreenTexture);gl.deleteRenderbuffer(offscreenRenderbuffer);resize()}function renderToCanvas(render,
canvasWidth,canvasHeight,halfObjectSize,rotateX,rotateY){var canvas=createCanvas(canvasWidth,canvasHeight);renderOffscreen(canvasWidth,canvasHeight,function(){var depth=400;var projection=[2/canvasWidth,0,0,0,0,-2/canvasHeight,0,0,0,0,2/depth,0,-1,1,0,1];var scale=canvasWidth/(halfObjectSize*3);var scaleMatrix=[scale,0,0,0,0,scale,0,0,0,0,scale,0,0,0,0,1];var transformStack=[projection,matrixTranslate4(canvasWidth/2,canvasHeight/2,-50),scaleMatrix,matrixRotateX4(rotateX),matrixRotateY4(rotateY)];
var oldTransforms=render.localTransforms;render.localTransforms=[];render.draw(context,transformStack,0);render.localTransforms=oldTransforms;var pixels=new Uint8Array(4*canvasWidth*canvasHeight);context.readPixels(0,0,canvasWidth,canvasHeight,context.RGBA,context.UNSIGNED_BYTE,pixels);var context2d=canvas.getContext("2d");var imageData=context2d.createImageData(canvasWidth,canvasHeight);imageData.data.set(pixels);context2d.putImageData(imageData,0,0)});return canvas}var playState={stateElementId:"p",
initState:function(stateListener){var xDown;var yDown;var timeDown;var xDiff;var yDiff;var eventListeners={"resize":function(){resize();redrawInventory()},"keydown":function(e){var type;var data;switch(e.keyCode){case 37:case 65:type=INPUT_TYPE_TURN;data={fromOrientationHint:viewer.entityOrientation,orientationDelta:-1};break;case 38:case 87:type=INPUT_TYPE_MOVE_FORWARD;break;case 39:case 68:type=INPUT_TYPE_TURN;data={fromOrientationHint:viewer.entityOrientation,orientationDelta:1};break;case 40:case 83:type=
INPUT_TYPE_LOOK_DOWN;break}queueInput({inputTypeId:type,inputData:data})},"click":function(e){handleSelect(e.clientX,e.clientY)},"touchstart":function(e){var touch=e.touches[0];xDown=touch.clientX;yDown=touch.clientY;if(xDown<canvas.width&&yDown<canvas.height){xDiff=0;yDiff=0;timeDown=e.timeStamp;e.preventDefault()}else timeDown=0},"touchmove":function(e){var touch=e.touches[0];xDiff=touch.clientX-xDown;yDiff=touch.clientY-yDown},"touchend":function(e){if(timeDown){var timeDiff=e.timeStamp-timeDown;
if(timeDiff<400)if(abs(xDiff)+abs(yDiff)<50)handleSelect(xDown,yDown);else{var type=void 0;var data_1;if(abs(xDiff)<abs(yDiff))if(yDiff>0)type=INPUT_TYPE_MOVE_FORWARD;else type=INPUT_TYPE_LOOK_DOWN;else{type=INPUT_TYPE_TURN;var orientationDelta=void 0;if(xDiff>0)orientationDelta=-1;else orientationDelta=1;data_1={fromOrientationHint:viewer.entityOrientation,orientationDelta:orientationDelta}}queueInput({inputTypeId:type,inputData:data_1})}}}};stateDefaultInit(playState,stateListener,eventListeners);
context=canvas.getContext("webgl");var gl=context;gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);gl.enable(gl.CULL_FACE);var fragmentShader=webglGetShader(gl,shapeRenderFragmentShaderScript,gl.FRAGMENT_SHADER);var vertexShader=webglGetShader(gl,shapeRenderVertexShaderScript,gl.VERTEX_SHADER);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(FEATURE_CHECK_SHADER_ERRORS)if(!gl.getProgramParameter(shaderProgram,
gl.LINK_STATUS))throw gl;gl.useProgram(shaderProgram);var surfaceVertices=[.5,0,.5,-.5,0,.5,.5,0,-.5,-.5,0,-.5];var surfaceIndices=[0,2,1,2,3,1];var surfaceTextureCoordinates=[1,1,0,1,1,0,0,0];surfaceRenderParams=shapeRenderInit(gl,shaderProgram,surfaceVertices,surfaceIndices,surfaceTextureCoordinates);halfDiceSize=halfDiceSize;var diceVertices=[-halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,
-halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,
-halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,halfDiceSize,-halfDiceSize,halfDiceSize,-halfDiceSize];var diceIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];diceTextureCoordinates=[0,0,.25,0,.25,.5,0,.5,.25,.5,.25,0,.5,0,.5,.5,.5,0,.75,
0,.75,.5,.5,.5,0,.5,.25,.5,.25,1,0,1,.25,1,.25,.5,.5,.5,.5,1,.5,.5,.75,.5,.75,1,.5,1];diceRenderParams=shapeRenderInit(gl,shaderProgram,diceVertices,diceIndices,diceTextureCoordinates);var healthRadius=.1;var healthInnerRadius=healthRadius*.6;var healthDepth=.02;var healthVertices=[0,healthRadius*.8,0,healthRadius*.2,healthRadius,0,healthRadius*.6,healthRadius,0,healthRadius,healthRadius*.6,0,healthRadius*.9,0,0,0,-healthRadius,0,-healthRadius*.9,0,0,-healthRadius,healthRadius*.6,0,-healthRadius*
.6,healthRadius,0,-healthRadius*.2,healthRadius,0,0,healthInnerRadius*.6,healthDepth,healthInnerRadius*.2,healthInnerRadius,healthDepth,healthInnerRadius*.6,healthInnerRadius,healthDepth,healthInnerRadius,healthInnerRadius*.6,healthDepth,healthInnerRadius*.9,0,healthDepth,0,-healthInnerRadius,healthDepth,-healthInnerRadius*.9,0,healthDepth,-healthInnerRadius,healthInnerRadius*.6,healthDepth,-healthInnerRadius*.6,healthInnerRadius,healthDepth,-healthInnerRadius*.2,healthInnerRadius,healthDepth,0,healthInnerRadius*
.6,-healthDepth,healthInnerRadius*.2,healthInnerRadius,-healthDepth,healthInnerRadius*.6,healthInnerRadius,-healthDepth,healthInnerRadius,healthInnerRadius*.6,-healthDepth,healthInnerRadius*.9,0,-healthDepth,0,-healthInnerRadius,-healthDepth,-healthInnerRadius*.9,0,-healthDepth,-healthInnerRadius,healthInnerRadius*.6,-healthDepth,-healthInnerRadius*.6,healthInnerRadius,-healthDepth,-healthInnerRadius*.2,healthInnerRadius,-healthDepth,0,0,healthDepth,0,0,-healthDepth];var healthIndices=[0,10,11,1,
0,11,1,11,12,2,1,12,2,12,13,3,2,13,3,13,14,4,3,14,4,14,15,5,4,15,5,15,16,6,5,16,6,16,17,7,6,17,7,17,18,8,7,18,8,18,19,9,8,19,9,19,10,0,9,10,20,0,21,0,1,21,21,1,22,1,2,22,22,2,23,2,3,23,23,3,24,3,4,24,24,4,25,4,5,25,25,5,26,5,6,26,26,6,27,6,7,27,27,7,28,7,8,28,28,8,29,8,9,29,29,9,20,9,0,20,11,10,30,12,11,30,13,12,30,14,13,30,15,14,30,16,15,30,17,16,30,18,17,30,19,18,30,10,19,30,20,21,31,21,22,31,22,23,31,23,24,31,24,25,31,25,26,31,26,27,31,27,28,31,28,29,31,29,20,31];var healthTextureCoordinates=[];
var i=0;while(i<healthVertices.length){var x=(healthVertices[i]+healthRadius)/(healthRadius*2);var y=(healthVertices[i+1]+healthRadius)/(healthRadius*2);healthTextureCoordinates.push(x,y);i+=3}healthRenderParams=shapeRenderInit(gl,shaderProgram,healthVertices,healthIndices,healthTextureCoordinates);var featurePotionNeckWidth=.02;var featurePotionNeckHeight=.1;var featurePotionBaseWidth=.08;var featurePotionVertices=[-featurePotionNeckWidth,featurePotionNeckHeight,featurePotionNeckWidth,featurePotionNeckWidth,
featurePotionNeckHeight,featurePotionNeckWidth,featurePotionNeckWidth,0,featurePotionNeckWidth,featurePotionBaseWidth,-featurePotionBaseHeight,featurePotionBaseWidth,-featurePotionBaseWidth,-featurePotionBaseHeight,featurePotionBaseWidth,-featurePotionNeckWidth,0,featurePotionNeckWidth,featurePotionNeckWidth,featurePotionNeckHeight,featurePotionNeckWidth,featurePotionNeckWidth,featurePotionNeckHeight,-featurePotionNeckWidth,featurePotionNeckWidth,0,-featurePotionNeckWidth,featurePotionBaseWidth,-featurePotionBaseHeight,
-featurePotionBaseWidth,featurePotionBaseWidth,-featurePotionBaseHeight,featurePotionBaseWidth,featurePotionNeckWidth,0,featurePotionNeckWidth,featurePotionNeckWidth,featurePotionNeckHeight,-featurePotionNeckWidth,-featurePotionNeckWidth,featurePotionNeckHeight,-featurePotionNeckWidth,-featurePotionNeckWidth,0,-featurePotionNeckWidth,-featurePotionBaseWidth,-featurePotionBaseHeight,-featurePotionBaseWidth,featurePotionBaseWidth,-featurePotionBaseHeight,-featurePotionBaseWidth,featurePotionNeckWidth,
0,-featurePotionNeckWidth,-featurePotionNeckWidth,featurePotionNeckHeight,-featurePotionNeckWidth,-featurePotionNeckWidth,featurePotionNeckHeight,featurePotionNeckWidth,-featurePotionNeckWidth,0,featurePotionNeckWidth,-featurePotionBaseWidth,-featurePotionBaseHeight,featurePotionBaseWidth,-featurePotionBaseWidth,-featurePotionBaseHeight,-featurePotionBaseWidth,-featurePotionNeckWidth,0,-featurePotionNeckWidth];var featurePotionIndices=[0,2,1,0,5,2,5,3,2,3,5,4,6,8,7,6,11,8,11,9,8,9,11,10,12,14,13,
12,17,14,17,15,14,15,17,16,18,20,19,18,23,20,23,21,20,21,23,22,0,6,12,18,0,12,4,22,10,10,22,16];var featurePotionTextureCoordinates=[];countForEach(4,function(){featurePotionTextureCoordinates.push(0,0,1,0,1,.5,1,1,0,1,0,.5)});featurePotionRenderParams=shapeRenderInit(gl,shaderProgram,featurePotionVertices,featurePotionIndices,featurePotionTextureCoordinates);resize();redraw();redrawInventory();var t=performance.now();update(t);var animationCallback=function(t){animationFrameRequest=requestAnimationFrame(animationCallback);
animate(t)};animationCallback(t);if(!updateAnimation)updateAnimation=consume(t,queuedLevelDeltas)},destroyState:function(){cancelAnimationFrame(animationFrameRequest);stateDefaultDestroy.apply(playState);arrayForEach(textures,function(texture){if(texture)context.deleteTexture(texture)});context=null}};return playState}}
function renderDefaultDraw(gl,transformStack,pickTextures){var render=this;arrayPushAll(transformStack,render.localTransforms);render.doDraw(gl,transformStack,pickTextures);var length=render.localTransforms.length;arraySplice(transformStack,transformStack.length-length,length)}
function compositeRenderFactory(localTransforms,childRenders){var render={childRenders:childRenders,draw:renderDefaultDraw,localTransforms:localTransforms,doDraw:function(gl,transformStack,pickTextures){mapForEach(render.childRenders,function(key,child){child.draw(gl,transformStack,pickTextures)})}};return render}
function entityRenderFactory(entity,position,rotation,healthRenders,diceRenders,tileRenders,redrawInventory,halfDiceSize,effectiveResourceCounts,effectiveHealth,soundEffects){function look(radians,height,stepBack){return matrixMultiply4(matrixRotateX4(radians),matrixTranslate4(0,-height,-stepBack))}function shortenAngle(a){a=a%pi2;if(a>pi)a-=pi2;return a}function getDiceTransformationStack(diceIndex,r,multiplier,translationMultiplier){if(translationMultiplier==nil)translationMultiplier=multiplier;
var a=shortenAngle(r+pi2*diceIndex/entity.diceSlots);var r2=shortenAngle(r*2);return[matrixRotateZ4(a*multiplier),matrixTranslate4(0,(.5-halfDiceSize*1.4)*translationMultiplier,0),matrixRotateZ4((-r2+pi/4)*multiplier),matrixRotateX4(pi*multiplier/4),matrixRotateY4(pi*multiplier/4)]}var r=0;var entityRender={update:function(t){r=t*5E-4},consume:function(t,delta){var animation;if(delta.deltaData&&delta.deltaData.entity==entity)switch(delta.deltaType){case LEVEL_DELTA_TYPE_MOVE_INVALID:soundEffects.stepFailed(random(),
entityRender.localTransforms);break;case LEVEL_DELTA_TYPE_MOVE:{var moveData=delta.deltaData;var dpos=ORIENTATION_DIFFS[moveData.moveDirection];var targetPosition=matrixTranslate4(moveData.fromX+dpos.x,.5,moveData.fromY+dpos.y);var duration=250;animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(position,valueFactoryMatrix4InterpolationFactory(matrixCopy4(position),targetPosition))])}break;case LEVEL_DELTA_TYPE_TURN:{var turnData=delta.deltaData;
var fromAngle=ORIENTATION_ANGLES[turnData.fromOrientation];var toAngle=ORIENTATION_ANGLES[turnData.toOrientation];toAngle=normalizeAngle(toAngle,fromAngle);var duration=250;animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(rotation,valueFactoryMatrix4RotationFactory(0,1,0,fromAngle,toAngle))])}break;case LEVEL_DELTA_TYPE_LOOK_DOWN:{var duration=250;animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(entityRender.headRotation,
valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),look(-pi/3,.5,.3)))])}break;case LEVEL_DELTA_TYPE_LOOK_UP:{var duration=250;animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),look(-pi/9,.3,.5)))])}break;case LEVEL_DELTA_TYPE_FALL:{var duration1=600;var duration2_1=600;var fallData=delta.deltaData;soundEffects.fall(1,
entityRender.localTransforms);animation=animationChainedProxyFactory(animationTweenFactory(t,duration1,easingQuadraticInFactory(duration1),[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),look(-piOn2,-.5,0)))]),function(t){return animationTweenFactory(t,duration2_1,easingQuadraticOutFactory(duration2_1),[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),
look(-piOn2,-1,0)))])})}break;case LEVEL_DELTA_TYPE_DROP_IN:{if(FEATURE_ANIMATE_FALL){var duration=999;animation=animationChainedProxyFactory(animationTweenFactory(t,duration,easingLinearFactory(duration),[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(look(-pi/2,1.5,0),look(-pi/9,.3,.5)))]),function(){soundEffects.stepFailed(.5,entityRender.localTransforms)})}}break;case LEVEL_DELTA_TYPE_COLLECT_DICE:{var collectDiceData_1=delta.deltaData;var tileRender=
tileRenders[collectDiceData_1.fromTileX][collectDiceData_1.fromTileY];var diceRender_1=tileRender.childRenders[collectDiceData_1.fromTilePosition];delete tileRender.childRenders[collectDiceData_1.fromTilePosition];var previousTransforms=copyArray(tileRender.localTransforms);arrayPushAll(previousTransforms,diceRender_1.localTransforms);var previousTransform=matrixMultiplyStack4(previousTransforms);var oldPosition=vectorTransform3Matrix4(0,0,0,previousTransform);var newTransforms=copyArray(entityRender.localTransforms);
var newTransform=matrixMultiplyStack4(newTransforms);var newPosition=vectorTransform3Matrix4(0,0,0,newTransform);var offsetTranslate=matrixTranslate4(oldPosition[0]-newPosition[0],halfDiceSize-newPosition[1],oldPosition[2]-newPosition[2]);var tileSlot=TILE_SLOTS_ALL[collectDiceData_1.fromTilePosition];var yAngle=tileSlot.slotRotation;var rnow_1=r;var offsetSpin=matrixMultiplyStack4(getDiceTransformationStack(collectDiceData_1.toDiceSlot,rnow_1,-1).reverse());var yRotation=matrixRotateY4(yAngle);var offsetRotate=
matrixInvert4(rotation);var rotateToAngle=ORIENTATION_ANGLES[entity.entityOrientation];var rotateTo=matrixIdentity4();var diceFaceRotation=DICE_FACE_ROTATIONS[collectDiceData_1.fromFace];var offsetDiceRotation=matrixCopy4(diceFaceRotation.matrix);diceRender_1.localTransforms=[offsetSpin,offsetRotate,offsetTranslate,rotateTo,yRotation,offsetDiceRotation];diceRender_1.animating=1;diceRenders[collectDiceData_1.dice.diceId]={render:diceRender_1,index:collectDiceData_1.toDiceSlot};var targetTransform=
matrixTranslate4(0,0,0);soundEffects.diceCollect(1,entityRender.localTransforms);var duration=999;animation=animationCompositeFactory([animationTweenFactory(t,duration,easingLinearFactory(duration),[effectCopyMatrixIntoFactory(offsetDiceRotation,valueFactoryMatrix4RotationFactory(diceFaceRotation.axisX,diceFaceRotation.axisY,diceFaceRotation.axisZ,diceFaceRotation.radians,0)),effectCopyMatrixIntoFactory(rotateTo,valueFactoryMatrix4RotationFactory(0,1,0,0,rotateToAngle)),effectCopyMatrixIntoFactory(yRotation,
valueFactoryMatrix4RotationFactory(0,1,0,yAngle,0)),effectCopyMatrixIntoFactory(offsetSpin,function(p,matrix){var value=matrixMultiplyStack4(getDiceTransformationStack(collectDiceData_1.toDiceSlot,rnow_1,p-1).reverse());matrixCopyInto4(value,matrix);return matrix})]),animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(offsetTranslate,valueFactoryMatrix4InterpolationFactory(matrixCopy4(offsetTranslate),targetTransform))])]);animation=animationChainedProxyFactory(animation,
function(){if(entity.behaviorType==BEHAVIOR_TYPE_PLAYER)redrawInventory();diceRender_1.animating=0})}break;case LEVEL_DELTA_TYPE_PLAY_DICE:{if(entity.behaviorType==BEHAVIOR_TYPE_PLAYER)redrawInventory();var playDiceData_1=delta.deltaData;var playedDiceRender=diceRenders[playDiceData_1.dice.diceId].render;delete diceRenders[playDiceData_1.dice.diceId];var toTileRender_1=tileRenders[playDiceData_1.toTileX][playDiceData_1.toTileY];toTileRender_1.childRenders[playDiceData_1.toTilePosition]=playedDiceRender;
var tileSlot=TILE_SLOTS_ALL[playDiceData_1.toTilePosition];var toFaceRotation=DICE_FACE_ROTATIONS[playDiceData_1.toFace];var rnow_2=r;var oldTransforms=matrixCopy4(entityRender.localTransforms);arrayPushAll(oldTransforms,getDiceTransformationStack(playDiceData_1.fromDiceSlot,rnow_2,1));var oldTransform=matrixMultiplyStack4(oldTransforms);var oldPosition=vectorTransform3Matrix4(0,0,0,oldTransform);var sourceTranslate=matrixTranslate4(oldPosition[0]-playDiceData_1.toTileX,oldPosition[1],oldPosition[2]-
playDiceData_1.toTileY);var targetTranslate=matrixTranslate4(tileSlot.dx,halfDiceSize,tileSlot.dy);var sourceDropHeight=matrixIdentity4();var targetDropHeight=matrixTranslate4(0,(entity.lookingDown?.2:.4)+random()/7,0);var offsetSpin=matrixMultiplyStack4(getDiceTransformationStack(playDiceData_1.fromDiceSlot,1,0));var sourceDiceFaceRotation=matrixIdentity4();var targetDiceFaceRotation=DICE_FACE_ROTATIONS[playDiceData_1.toFace];var rotationY=matrixCopy4(rotation);var rotationYFrom=ORIENTATION_ANGLES[entity.entityOrientation];
var rotationYTo=tileSlot.slotRotation;playedDiceRender.localTransforms=[sourceTranslate,sourceDropHeight,rotationY,offsetSpin,sourceDiceFaceRotation];soundEffects.diceThrow(random(),entityRender.localTransforms);var duration1=800;var duration2=600;animation=animationCompositeFactory([animationTweenFactory(t,duration1,easingQuadraticOutFactory(duration1),[effectCopyMatrixIntoFactory(sourceTranslate,valueFactoryMatrix4InterpolationFactory(matrixCopy4(sourceTranslate),targetTranslate)),effectCopyMatrixIntoFactory(sourceDiceFaceRotation,
valueFactoryMatrix4RotationFactory(targetDiceFaceRotation.axisX,targetDiceFaceRotation.axisY,targetDiceFaceRotation.axisZ,0,targetDiceFaceRotation.radians+pi2)),effectCopyMatrixIntoFactory(rotationY,valueFactoryMatrix4RotationFactory(0,1,0,rotationYFrom,rotationYTo)),effectCopyMatrixIntoFactory(offsetSpin,function(p,into){var t=matrixMultiplyStack4(getDiceTransformationStack(playDiceData_1.fromDiceSlot,rnow_2,1-p,0));matrixCopyInto4(t,into);return into})]),animationChainedProxyFactory(animationTweenFactory(t,
duration2,easingQuadraticOutFactory(duration2/2),[effectCopyMatrixIntoFactory(sourceDropHeight,valueFactoryMatrix4InterpolationFactory(matrixCopy4(sourceDropHeight),targetDropHeight))]),function(){soundEffects.diceLand(random(),toTileRender_1.localTransforms)})])}break;case LEVEL_DELTA_TYPE_RESOURCE_CHANGE:var levelDeltaDataResourceChange=delta.deltaData;entityRender.effectiveResourceCounts=levelDeltaDataResourceChange.newEffectiveResourceCounts;case LEVEL_DELTA_TYPE_DICE_SLOTS_CHANGE:if(levelDeltaDataResourceChange.entity.behaviorType==
BEHAVIOR_TYPE_PLAYER)redrawInventory();break;case LEVEL_DELTA_TYPE_HEALTH_CHANGE:{var levelDeltaDataHealthChange_1=delta.deltaData;entityRender.effectiveHealth=levelDeltaDataHealthChange_1.totalHealth;if(levelDeltaDataHealthChange_1.deltaHealth<0)soundEffects.hurt(-levelDeltaDataHealthChange_1.deltaHealth/2,entityRender.localTransforms);if(levelDeltaDataHealthChange_1.entity.behaviorType==BEHAVIOR_TYPE_PLAYER){if(levelDeltaDataHealthChange_1.deltaHealth<0){var duration_1=300;animation=animationTweenFactory(t,
duration_1,function(t){var m=1-easingQuadraticOutFactory(duration_1)(t);return random()*m},[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),matrixRotate4(random(),random(),random(),pi/6)))])}redrawInventory()}else{var animations_2=[];countForEach(abs(levelDeltaDataHealthChange_1.deltaHealth),function(i){var effects;var transforms;var slot;if(levelDeltaDataHealthChange_1.deltaHealth>0){slot=levelDeltaDataHealthChange_1.totalHealth-
i-1;var rotation_1=matrixRotateZ4(pi);var scale=matrixScale4(0,0,0);transforms=[rotation_1,scale];effects=[effectCopyMatrixIntoFactory(rotation_1,valueFactoryMatrix4RotationFactory(0,0,1,pi2,0)),effectCopyMatrixIntoFactory(scale,valueFactoryMatrix4InterpolationFactory(matrixCopy4(scale),matrixIdentity4()))]}else{slot=levelDeltaDataHealthChange_1.totalHealth+i;var rotation_2=matrixIdentity4();var scale=matrixIdentity4();transforms=[rotation_2,scale];effects=[effectCopyMatrixIntoFactory(rotation_2,
valueFactoryMatrix4RotationFactory(1,0,0,0,pi2)),effectCopyMatrixIntoFactory(scale,valueFactoryMatrix4InterpolationFactory(matrixCopy4(scale),matrixScale4(0,0,0)))]}var healthRender=healthRenders[slot];healthRender.localTransforms=transforms;var duration=999;var animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),effects);animations_2.push(animation)});animation=animationCompositeFactory(animations_2)}}break;case LEVEL_DELTA_TYPE_DIE:{if(entity.behaviorType==BEHAVIOR_TYPE_PLAYER){var duration=
1E3;animation=animationTweenFactory(t,duration,easingQuadraticInFactory(duration),[effectCopyMatrixIntoFactory(entityRender.headRotation,valueFactoryMatrix4InterpolationFactory(matrixCopy4(entityRender.headRotation),matrixRotateZ4(-pi/2)))])}}break;case LEVEL_DELTA_TYPE_CONSUME_FEATURE:{var levelDataConsumeFeature=delta.deltaData;var tileRender_1=tileRenders[levelDataConsumeFeature.fromTileX][levelDataConsumeFeature.fromTileY];if(FEATURE_ANIMATE_CONSUME_FEATURE){var featureRender=tileRender_1.childRenders["b"];
var oldTransforms=matrixCopy4(featureRender.localTransforms);var oldTransform=matrixMultiplyStack4(oldTransforms);var oldPosition=vectorTransform3Matrix4(0,0,0,oldTransform);var rotationAngle=ORIENTATION_ANGLES[entity.entityOrientation];var rotateY=matrixRotateY4(rotationAngle);var rotateX=matrixIdentity4();var scale_1=matrixIdentity4();var translate=matrixIdentity4();featureRender.localTransforms.push(translate,scale_1,rotateY,rotateX);var duration_2=999;animation=animationTweenFactory(t,duration_2,
easingQuadraticInFactory(duration_2),[effectCopyMatrixIntoFactory(translate,valueFactoryMatrix4InterpolationFactory(matrixCopy4(translate),matrixTranslate4(0,-oldPosition[1]+.7,0))),effectCopyMatrixIntoFactory(rotateX,valueFactoryMatrix4RotationFactory(1,0,0,0,-pi2/3))]);animation=animationChainedProxyFactory(animation,function(t){soundEffects.powerup(1,entityRender.localTransforms);return animationChainedProxyFactory(animationTweenFactory(t,duration_2,easingQuadraticInFactory(duration_2),[effectCopyMatrixIntoFactory(scale_1,
valueFactoryMatrix4InterpolationFactory(matrixCopy4(scale_1),matrixScale4(1,0,0)))]),function(){delete tileRender_1.childRenders["b"]})})}else delete tileRender_1.childRenders["b"]}break}return animation},draw:renderDefaultDraw,doDraw:function(gl,transformStack,pickTexture){var renderAll=entity.behaviorType!=BEHAVIOR_TYPE_PLAYER;mapForEach(diceRenders,function(diceId,diceRenderAndIndex){var diceRender=diceRenderAndIndex.render;if(diceRender.animating||renderAll){var i=diceRenderAndIndex.index;var diceTransformationStack=
getDiceTransformationStack(i,r,1);arrayPushAll(transformStack,diceTransformationStack);diceRender.draw(gl,transformStack,pickTexture);arraySplice(transformStack,transformStack.length-diceTransformationStack.length,diceTransformationStack.length)}});if(renderAll){var radius_1;if(entity.healthSlots>1)radius_1=.11;else radius_1=0;arrayForEach(healthRenders,function(healthRender,i){if(i<=entityRender.effectiveHealth||healthRender.animating){var a=-r/4+pi2*i/entity.healthSlots;arrayPushAll(transformStack,
[matrixRotateZ4(a),matrixTranslate4(0,radius_1,0),matrixRotateZ4(-a),matrixRotateY4(r)]);healthRender.draw(gl,transformStack,pickTexture);arraySplice(transformStack,transformStack.length-4,4)}})}},entity:entity,headRotation:look(-pi/9,.3,.5),bodyPosition:position,bodyRotation:rotation,localTransforms:[position,rotation],healthRenders:healthRenders,diceRenders:diceRenders,effectiveResourceCounts:effectiveResourceCounts,effectiveHealth:effectiveHealth};return entityRender}
var shapeRenderFragmentShaderScript="varying highp vec2 d;uniform sampler2D e;void main(){gl_FragColor=texture2D(e,d);}";var shapeRenderVertexShaderScript="attribute vec3 a;attribute vec2 b;uniform mat4 c;varying highp vec2 d;void main(){gl_Position=c*vec4(a,1),d=b;}";
function shapeRenderInit(gl,program,vertices,indices,textureCoordinates){var uTransform=gl.getUniformLocation(program,"c");var uSampler=gl.getUniformLocation(program,"e");var aVertexPosition=gl.getAttribLocation(program,"a");var aTextureCoord=gl.getAttribLocation(program,"b");var vertexBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);var indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,
indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(indices),gl.STATIC_DRAW);var textureCoordinatesBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,textureCoordinatesBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(textureCoordinates),gl.STATIC_DRAW);return{indexBuffer:indexBuffer,vertexBuffer:vertexBuffer,aVertexPosition:aVertexPosition,indexBufferLength:indices.length,uTransform:uTransform,aTextureCoord:aTextureCoord,uSampler:uSampler,textureCoordinatesBuffer:textureCoordinatesBuffer}}
function shapeRenderFactory(localTransforms,params,normalTexture,pickTexture){return{localTransforms:localTransforms,draw:renderDefaultDraw,doDraw:function(gl,transformStack,usePickTexture){var texture=usePickTexture?pickTexture:normalTexture;if(texture){var transform=matrixMultiplyStack4(transformStack);gl.bindBuffer(gl.ARRAY_BUFFER,params.vertexBuffer);gl.vertexAttribPointer(params.aVertexPosition,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(params.aVertexPosition);gl.bindBuffer(gl.ARRAY_BUFFER,
params.textureCoordinatesBuffer);gl.vertexAttribPointer(params.aTextureCoord,2,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(params.aTextureCoord);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,params.indexBuffer);gl.uniformMatrix4fv(params.uTransform,false,transform);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture);gl.uniform1i(params.uSampler,0);gl.drawElements(gl.TRIANGLES,params.indexBufferLength,gl.UNSIGNED_SHORT,0)}}}}
function localStorageGameServiceFactory(prefix){function saveGame(game){game.updated=(new Date).toLocaleString();ls.setItem(prefix+game.gameId,JSON.stringify(game))}var result={getUniverse:function(){var universe;if(FEATURE_PERSISTENCE){var universeString=ls.getItem(prefix);if(universeString)universe=JSON.parse(universeString)}if(!universe)universe={gameIds:[],nextGameId:1};return universe},getGames:function(gameIds){var games=[];if(FEATURE_PERSISTENCE)arrayForEach(gameIds,function(gameId){var gameString=
ls.getItem(prefix+gameId);var game=JSON.parse(gameString);arrayPush(games,game)});return games},createGame:function(){var universe=result.getUniverse();var gameId=universe.nextGameId++;arrayPush(universe.gameIds,gameId);ls.setItem(prefix,JSON.stringify(universe));var now=(new Date).toString();var game={gameId:gameId,created:now,nextLevelId:1,nextEntityId:1};if(FEATURE_PERSISTENCE)saveGame(game);return game},createLevel:function(game,width,height,tiles){var level={gameId:game.gameId,levelId:game.nextLevelId++,
levelWidth:width,levelHeight:height,tiles:tiles};if(FEATURE_PERSISTENCE)saveGame(game);return level},getLevel:function(game,levelId){var level;if(FEATURE_PERSISTENCE){var levelString=ls.getItem(prefix+game.gameId+"_"+levelId);if(levelString)level=JSON.parse(levelString)}return level},saveLevel:function(game,level){if(FEATURE_PERSISTENCE){saveGame(game);if(level)ls.setItem(prefix+game.gameId+"_"+level.levelId,JSON.stringify(level))}}};return result}
function calculateVolume(listenerTransformStack,soundTransformStack){var listenerTransform=matrixMultiplyStack4(listenerTransformStack);var soundTransform=matrixMultiplyStack4(soundTransformStack);var listenerLocation=vectorTransform3Matrix4(0,0,0,listenerTransform);var soundLocation=vectorTransform3Matrix4(0,0,0,soundTransform);var dx=soundLocation[0]-listenerLocation[0];var dy=soundLocation[1]-listenerLocation[1];var dz=soundLocation[2]-listenerLocation[2];var distanceSquared=dx*dx+dy*dy+dz*dz;
return 1/(distanceSquared/3+1)}
function linearRampGain(gain,now,attackVolume,sustainVolume,attackSeconds,decaySeconds,sustainSeconds,durationSeconds,volumeScale){gain.gain.value=0;gain.gain.setValueAtTime(0,now);gain.gain.linearRampToValueAtTime(attackVolume*volumeScale,now+attackSeconds);gain.gain.linearRampToValueAtTime(sustainVolume*volumeScale,now+decaySeconds);if(sustainSeconds)gain.gain.linearRampToValueAtTime(sustainVolume*volumeScale,now+sustainSeconds);gain.gain.linearRampToValueAtTime(0,now+durationSeconds)}
function webAudioToneSoundEffectFactory(audioContext,listenerLocationSource,oscillatorType,startFrequency,endFrequency,frequencyRange,attackSeconds,decaySeconds,sustainSeconds,durationSeconds){return function(intensity,soundLocation){if(FEATURE_SOUND){var listenerLocation=listenerLocationSource();var volumeScale=calculateVolume(listenerLocation,soundLocation);if(audioContext){var now=audioContext.currentTime;var oscillator=audioContext.createOscillator();oscillator.frequency.setValueAtTime(Math.max(1,
startFrequency+frequencyRange*intensity),now);oscillator.frequency.linearRampToValueAtTime(Math.max(1,endFrequency+frequencyRange*intensity),now+durationSeconds);oscillator.type=oscillatorType;var gain=audioContext.createGain();linearRampGain(gain,now,.2*volumeScale,.1*volumeScale,attackSeconds,decaySeconds,sustainSeconds,durationSeconds,volumeScale);oscillator.connect(gain);gain.connect(audioContext.destination);oscillator.start();setTimeout(function(){oscillator.stop()},durationSeconds*1E3)}}}}
function webAudioVibratoSoundFactory(audioContext,listenerLocationSource,startFrequency,endFrequency,vibrations,durationSeconds){return function(intensity,soundLocation){if(FEATURE_SOUND)if(audioContext){var listenerLocation=listenerLocationSource();var volumeScale=calculateVolume(listenerLocation,soundLocation);var now=audioContext.currentTime;var oscillator=audioContext.createOscillator();oscillator.frequency.setValueAtTime(startFrequency,now);oscillator.frequency.linearRampToValueAtTime(endFrequency,
now+durationSeconds);oscillator.type="square";oscillator.start();var gain=audioContext.createGain();linearRampGain(gain,now,.2,.1,0,durationSeconds*.1,durationSeconds*.2,durationSeconds,volumeScale);var vibrato=audioContext.createOscillator();vibrato.frequency.value=vibrations/durationSeconds;vibrato.type="sawtooth";vibrato.start();var vibratoGain=audioContext.createGain();vibratoGain.gain.value=-1E3;oscillator.connect(gain);vibrato.connect(vibratoGain);vibratoGain.connect(oscillator.detune);gain.connect(audioContext.destination);
setTimeout(function(){oscillator.disconnect();gain.disconnect();vibratoGain.disconnect();oscillator.stop();vibrato.stop()},durationSeconds*1E3)}}}var STATE_TYPE_HOME=0;var STATE_TYPE_PLAY=1;function arrayForEach(array,f){array.forEach(f)}function arrayForEachReverse(a,f){for(var i=a.length;i>0;){i--;var v=a[i];if(f(v,i))arraySplice(a,i,1)}return!a.length}function arrayPushAll(into,values){into.push.apply(into,values)}
function colorToHex(a){var hex="#";arrayForEach(a,function(v){var h=v.toString(16);hex+=h});return hex}function copyArray(a){var result=[];arrayPushAll(result,a);return result}function countForEach(to,f){for(var i=0;i<to;i++)f(i)}function create2DArray(width,height,fillFunction){var array=[];for(var x=0;x<width;x++){var column=[];for(var y=0;y<height;y++)arrayPush(column,fillFunction(x,y,array));arrayPush(array,column)}return array}
function createCanvas(width,height){var canvas=createElement("canvas");canvas.width=width;canvas.height=height;return canvas}
function createDiceTexture(width,height,textureCoordinates,dice){var canvas=createCanvas(width,height);var ctx=canvas.getContext("2d");var backgroundColor=DICE_TYPE_COLORS[dice.diceType];ctx.strokeStyle="#000";ctx.textAlign="center";ctx.textBaseline="middle";var _loop_2=function(side){var symbols=dice.symbols[side];var textureCoordinateOffset=side*8;var xa=width*textureCoordinates[textureCoordinateOffset];var ya=height*textureCoordinates[textureCoordinateOffset+1];var xb=width*textureCoordinates[textureCoordinateOffset+
4];var yb=height*textureCoordinates[textureCoordinateOffset+5];var x1=min(xa,xb);var y1=min(ya,yb);var x2=max(xa,xb);var y2=max(ya,yb);var dw=x2-x1;var dh=y2-y1;var gradient=ctx.createRadialGradient(x1+dw/2,y1+dh/2,dh/4,x1+dw/2,y1+dh/2,dh*2);gradient.addColorStop(0,backgroundColor);gradient.addColorStop(1,"#000");ctx.fillStyle=gradient;ctx.fillRect(x1,y1,dw,dh);var symbolCount=symbols.length;if(symbolCount){var span_1=2;var cellSize_1=dh/span_1;var cx_1=0;var cy_1=0;ctx.font=""+cellSize_1*1.2+"px serif";
arrayForEach(symbols,function(symbol,i){var character=DICE_SYMBOL_CHARACTERS[symbol];var color=DICE_SYMBOL_COLORS[symbol];var angleOffset=DICE_SYMBOL_ROTATION[symbol];if(!color)color=backgroundColor;var tx=cx_1+cellSize_1/2;var ty=cy_1+cellSize_1/2;var angle=Math.atan2(ty-dh/2,tx-dw/2)+angleOffset;ctx.save();ctx.translate(x1+tx,y1+ty);ctx.rotate(angle);ctx.fillStyle=color;ctx.fillText(character,0,0);ctx.strokeText(character,0,0);ctx.restore();cx_1+=cellSize_1;if(i%span_1==span_1-1){cx_1=0;cy_1+=cellSize_1}})}if(dice.diceLevel){var levelFontSize=
dh*.4;ctx.fillStyle="#000";ctx.beginPath();ctx.arc(x1+dw/2,y1+dh/2,levelFontSize/2,pi,-pi);ctx.fill();ctx.font="bold "+levelFontSize+"px serif";ctx.fillStyle="#fff";ctx.fillText(dice.diceLevel,x1+dw/2,y1+dh/2)}};for(var side=0;side<6;side++)_loop_2(side);return canvas}
function createPickTexture(id){var width=32;var height=32;var canvas=createCanvas(width,height);var ctx=canvas.getContext("2d");var color=id.toString(16);while(color.length<6)color="0"+color;color="#"+color;ctx.fillStyle=color;ctx.fillRect(0,0,width,height);return canvas}function createRandomColor(rng,min,total){var x=min+rng(total-min*3);var y=min+rng(total-min*2-x);var z=total-x-y;var a=[x,y,z];var i=rng(3);var v=a[i];arraySplice(a,i,1);arrayPush(a,v);return a}
function createRandomWallColors(rng){var wallLower=createRandomColor(rng,3,12);var d=3-max(abs(wallLower[1]-wallLower[0]),abs(wallLower[2]-wallLower[0]),abs(wallLower[2]-wallLower[1]));var wallUpper=createRandomColor(rng,6,18+rng(d));var floor=[];var grout=[];var up=rng(2);var i=rng(2);if(i){var tmp=wallUpper;wallUpper=wallLower;wallLower=tmp}for(var i_1=0;i_1<3;i_1++){arrayPush(floor,ceil((wallUpper[i_1]+wallLower[i_1])/2+up));arrayPush(grout,max(0,min(wallUpper[i_1],wallLower[i_1])-3))}return{wallLower:colorToHex(wallLower),
wallUpper:colorToHex(wallUpper),grout:colorToHex(grout),floor:colorToHex(floor)}}
function createRepeatingBrickPattern(rng,width,height,bricksAcross,bricksDown,brickOffsetFraction,initialBrickOffsetFraction,upperBrickColor,lowerBrickColor,brickRounding,groutWidth,groutColor,text){var brickWidth=(width-groutWidth*bricksAcross)/bricksAcross;var brickHeight=(height-groutWidth*bricksDown)/bricksDown;var brickOffset=brickOffsetFraction*brickWidth;var initialBrickOffset=initialBrickOffsetFraction*brickWidth+groutWidth/2;var canvas=createCanvas(width,height);var ctx=canvas.getContext("2d");
var brickColor=ctx.createLinearGradient(0,0,0,height);brickColor.addColorStop(0,upperBrickColor);brickColor.addColorStop(1,lowerBrickColor);ctx.fillStyle=groutColor;ctx.fillRect(0,0,width,height);ctx.strokeStyle=groutColor;var count=0;var y=groutWidth/2;var xoffset=initialBrickOffset;while(y<height){var x=xoffset-brickWidth-groutWidth;while(x<width){ctx.fillStyle=brickColor;var whole=x>=0&&x<=width-brickWidth;if(whole){var r=rng();ctx.globalAlpha=1-r*r*r*r*.3}ctx.beginPath();if(FEATURE_ROUNDED_BRICKS){ctx.moveTo(x+
brickRounding,y);ctx.lineTo(x+brickWidth-brickRounding,y);ctx.arc(x+brickWidth-brickRounding,y+brickRounding,brickRounding,-piOn2,0);ctx.lineTo(x+brickWidth,y+brickHeight-brickRounding);ctx.arc(x+brickWidth-brickRounding,y+brickHeight-brickRounding,brickRounding,0,piOn2);ctx.lineTo(x+brickRounding,y+brickHeight);ctx.arc(x+brickRounding,y+brickHeight-brickRounding,brickRounding,piOn2,pi);ctx.lineTo(x,y+brickRounding);ctx.arc(x+brickRounding,y+brickRounding,brickRounding,-pi,-piOn2);ctx.closePath()}else ctx.rect(x,
y,brickWidth,brickHeight);ctx.fill();if(groutWidth){ctx.globalAlpha=.3;ctx.lineWidth=groutWidth*2;ctx.stroke();ctx.globalAlpha=1}if(text&&whole){var c_1=""+text[count++%text.length];ctx.textAlign="center";ctx.textBaseline="top";var fontSize=floor(min(brickHeight,brickWidth*1.5/max(1,c_1.length))*(.8+rng()*.2));ctx.font=""+fontSize+"px serif";ctx.fillStyle=groutColor;ctx.fillText(c_1,x+brickWidth/2,y)}x+=brickWidth+groutWidth}xoffset=(xoffset+brickOffset)%brickWidth;y+=brickHeight+groutWidth}return canvas}
function mapForEach(map,f){for(var key in map){var value=map[key];f(key,value)}}function mathRandomNumberGenerator(range){var result=random();if(range!=nil)result=floor(result*range);return result}function normalizeAngle(angle,against){while(angle<against-pi)angle+=pi2;while(angle>against+pi)angle-=pi2;return angle}function randomizeArray(rng,a,chance){arrayForEach(a,function(v,i){if(chance==nil||rng()<chance){var x=rng(a.length);var tmp=a[x];a[x]=a[i];a[i]=tmp}})}
function webglCanvasToTexture(gl,canvas){var texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,canvas);gl.generateMipmap(gl.TEXTURE_2D);return texture}
function webglGetShader(gl,theSource,type){var shader;shader=gl.createShader(type);gl.shaderSource(shader,theSource);gl.compileShader(shader);if(FEATURE_CHECK_SHADER_ERRORS)if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(shader);return shader}
w.onload=function(){var levelPopulator=levelPopulatorTileMazeFactory(.1,.4,1,.5);var gameService=localStorageGameServiceFactory("l");var stateFactories={};var localHomeStateFactory=homeStateFactory(gameService);var audioContext;if(FEATURE_SOUND)if(w["AudioContext"])audioContext=new AudioContext;else if(FEATURE_SOUND_LEGACY_WEB_AUDIO&&w["webkitAudioContext"])audioContext=new w["webkitAudioContext"];stateFactories[STATE_TYPE_HOME]=localHomeStateFactory;stateFactories[STATE_TYPE_PLAY]=playStateFactory(audioContext,
gameService,levelPopulator,localHomeStateFactory);var stateFactory=delegatingStateFactory(stateFactories);var currentState;var stateListener=function(stateTypeId,data){if(currentState)currentState.destroyState();currentState=stateFactory(stateTypeId,data);if(currentState)currentState.initState(stateListener)};stateListener(STATE_TYPE_HOME)};
